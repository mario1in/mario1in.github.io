<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="现象最近发现一个很神奇的bug，加入某个会议之后然后退出，重复3次，界面就无法旋转了。 猜测猜测1⃣️无法旋转，在确认旋转锁定关闭的情况下，第一个想法是，看看support orientation 相关的函数返回值是否正确。 12345func application(_ application: UIApplication, supportedInterfaceOrientationsFor w">
<meta name="keywords" content="iOS,Orientation">
<meta property="og:type" content="article">
<meta property="og:title" content="一个奇怪的旋转问题">
<meta property="og:url" content="https://shixiong.name/2019/07/30/find-a-wierd-bug/index.html">
<meta property="og:site_name" content="Mario1in">
<meta property="og:description" content="现象最近发现一个很神奇的bug，加入某个会议之后然后退出，重复3次，界面就无法旋转了。 猜测猜测1⃣️无法旋转，在确认旋转锁定关闭的情况下，第一个想法是，看看support orientation 相关的函数返回值是否正确。 12345func application(_ application: UIApplication, supportedInterfaceOrientationsFor w">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2022-10-27T07:38:38.224Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一个奇怪的旋转问题">
<meta name="twitter:description" content="现象最近发现一个很神奇的bug，加入某个会议之后然后退出，重复3次，界面就无法旋转了。 猜测猜测1⃣️无法旋转，在确认旋转锁定关闭的情况下，第一个想法是，看看support orientation 相关的函数返回值是否正确。 12345func application(_ application: UIApplication, supportedInterfaceOrientationsFor w">
    
    
        
          
              <link rel="shortcut icon" href="https://www.gravatar.com/avatar/44d0a14e3bc196dd6c90a9bd85f1f617?s=16">
          
        
        
          
            <link rel="icon" type="image/png" href="https://www.gravatar.com/avatar/44d0a14e3bc196dd6c90a9bd85f1f617?s=192" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="https://www.gravatar.com/avatar/44d0a14e3bc196dd6c90a9bd85f1f617?s=180">
          
        
    
    <!-- title -->
    <title>一个奇怪的旋转问题</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">home</a></li>
         
          <li><a href="/buddy/">links</a></li>
         
          <li><a href="/about/">about</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2022/10/27/2022-10-27-principle/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/03/29/note-to-myself-on-software-engineering/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://shixiong.name/2019/07/30/find-a-wierd-bug/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://shixiong.name/2019/07/30/find-a-wierd-bug/&text=一个奇怪的旋转问题"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://shixiong.name/2019/07/30/find-a-wierd-bug/&title=一个奇怪的旋转问题"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://shixiong.name/2019/07/30/find-a-wierd-bug/&is_video=false&description=一个奇怪的旋转问题"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=一个奇怪的旋转问题&body=Check out this article: https://shixiong.name/2019/07/30/find-a-wierd-bug/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://shixiong.name/2019/07/30/find-a-wierd-bug/&title=一个奇怪的旋转问题"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://shixiong.name/2019/07/30/find-a-wierd-bug/&title=一个奇怪的旋转问题"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://shixiong.name/2019/07/30/find-a-wierd-bug/&title=一个奇怪的旋转问题"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://shixiong.name/2019/07/30/find-a-wierd-bug/&title=一个奇怪的旋转问题"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://shixiong.name/2019/07/30/find-a-wierd-bug/&name=一个奇怪的旋转问题&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#现象"><span class="toc-number">1.</span> <span class="toc-text">现象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#猜测"><span class="toc-number">2.</span> <span class="toc-text">猜测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#猜测1⃣️"><span class="toc-number">2.1.</span> <span class="toc-text">猜测1⃣️</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#猜测2⃣️"><span class="toc-number">2.2.</span> <span class="toc-text">猜测2⃣️</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#寻找思路"><span class="toc-number">3.</span> <span class="toc-text">寻找思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定位问题"><span class="toc-number">4.</span> <span class="toc-text">定位问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结论"><span class="toc-number">5.</span> <span class="toc-text">结论</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        一个奇怪的旋转问题
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">Mario1in</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-07-30T10:24:32.000Z" itemprop="datePublished">2019-07-30</time>
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Orientation/">Orientation</a>, <a class="tag-link" href="/tags/iOS/">iOS</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>最近发现一个很神奇的bug，加入某个会议之后然后退出，重复3次，界面就无法旋转了。</p>
<h2 id="猜测"><a href="#猜测" class="headerlink" title="猜测"></a>猜测</h2><h3 id="猜测1⃣️"><a href="#猜测1⃣️" class="headerlink" title="猜测1⃣️"></a>猜测1⃣️</h3><p>无法旋转，在确认旋转锁定关闭的情况下，第一个想法是，看看support orientation 相关的函数返回值是否正确。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">func application(_ application: UIApplication, supportedInterfaceOrientationsFor window: UIWindow?) -&gt; UIInterfaceOrientationMask</span><br><span class="line"></span><br><span class="line">open override var shouldAutorotate: Bool </span><br><span class="line"></span><br><span class="line">open override var supportedInterfaceOrientations: UIInterfaceOrientationMask</span><br></pre></td></tr></table></figure>
<p>于是打了三个全局断点，一个一个调试…</p>
<p>果不其然…<br>都<strong>没什么问题</strong>…</p>
<p>但是这里有个现象，当出现bug（即无法旋转）的时候，这些函数都不会被调用了。</p>
<h3 id="猜测2⃣️"><a href="#猜测2⃣️" class="headerlink" title="猜测2⃣️"></a>猜测2⃣️</h3><p>如果不是支持方向不对的话，回头看了一下现象：重复三次…<br>于是继续猜测，会不会跟内存泄漏有关，之前有遇到过内存相关问题的现象也是重复操作n次出现。</p>
<p>于是调试了一下…</p>
<p>果不其然…<br>还是<strong>没什么问题</strong>…</p>
<h2 id="寻找思路"><a href="#寻找思路" class="headerlink" title="寻找思路"></a>寻找思路</h2><p>前面的猜测都不对，一下子就懵逼了，毫无头绪。后来仔细想了想，要不试试从系统接口找找问题，既然要旋转，最后肯定会落地到系统层面的某个方法上。</p>
<p>于是打了个断点在 <code>-[UIViewController shouldAutorotate]</code></p>
<p>当设备可以旋转的时候，调用栈如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1</span><br><span class="line">  * frame #<span class="number">0</span>: <span class="number">0x00000001d039de80</span> UIKitCore`-[UIViewController shouldAutorotate]</span><br><span class="line">    frame #<span class="number">1</span>: <span class="number">0x00000001d039f8b8</span> UIKitCore`-[UIViewController _updateLastKnownInterfaceOrientationOnPresentionStack:] + <span class="number">144</span></span><br><span class="line">    frame #<span class="number">2</span>: <span class="number">0x00000001d03a0e84</span> UIKitCore`-[UIViewController window:willAnimateRotationToInterfaceOrientation:duration:newSize:] + <span class="number">92</span></span><br><span class="line">    frame #<span class="number">3</span>: <span class="number">0x00000001d03a8270</span> UIKitCore`__95-[UIViewController(AdaptiveSizing) _window:viewWillTransitionToSize:withTransitionCoordinator:]_block_invoke<span class="number">.3392</span> + <span class="number">48</span></span><br><span class="line">    frame #<span class="number">4</span>: <span class="number">0x00000001d03af570</span> UIKitCore`-[_UIViewControllerTransitionCoordinator _applyBlocks:releaseBlocks:] + <span class="number">264</span></span><br><span class="line">    frame #<span class="number">5</span>: <span class="number">0x00000001d03abb64</span> UIKitCore`-[_UIViewControllerTransitionContext __runAlongsideAnimations] + <span class="number">176</span></span><br><span class="line">    frame #<span class="number">6</span>: <span class="number">0x00000001d0da7f40</span> UIKitCore`+[UIView(UIViewAnimationWithBlocks) _setupAnimationWithDuration:delay:view:options:factory:animations:start:animationStateGenerator:completion:] + <span class="number">608</span></span><br><span class="line">    frame #<span class="number">7</span>: <span class="number">0x00000001d0da8480</span> UIKitCore`+[UIView(UIViewAnimationWithBlocks) animateWithDuration:delay:options:animations:completion:] + <span class="number">108</span></span><br><span class="line">    frame #<span class="number">8</span>: <span class="number">0x000000010710a74c</span> Glip`+[UIView(instrumentation) ADEumAnimateWithDuration:delay:options:animations:completion:] + <span class="number">300</span></span><br><span class="line">    frame #<span class="number">9</span>: <span class="number">0x00000001d03c29e8</span> UIKitCore`__58-[_UIWindowRotationAnimationController animateTransition:]_block_invoke_2 + <span class="number">308</span></span><br><span class="line">    frame #<span class="number">10</span>: <span class="number">0x00000001d0dac560</span> UIKitCore`+[UIView(Internal) _performBlockDelayingTriggeringResponderEvents:] + <span class="number">220</span></span><br><span class="line">    frame #<span class="number">11</span>: <span class="number">0x00000001d03c2778</span> UIKitCore`__58-[_UIWindowRotationAnimationController animateTransition:]_block_invoke + <span class="number">128</span></span><br><span class="line">    frame #<span class="number">12</span>: <span class="number">0x00000001d0da7f40</span> UIKitCore`+[UIView(UIViewAnimationWithBlocks) _setupAnimationWithDuration:delay:view:options:factory:animations:start:animationStateGenerator:completion:] + <span class="number">608</span></span><br><span class="line">    frame #<span class="number">13</span>: <span class="number">0x00000001d0da8480</span> UIKitCore`+[UIView(UIViewAnimationWithBlocks) animateWithDuration:delay:options:animations:completion:] + <span class="number">108</span></span><br><span class="line">    frame #<span class="number">14</span>: <span class="number">0x000000010710a74c</span> Glip`+[UIView(instrumentation) ADEumAnimateWithDuration:delay:options:animations:completion:] + <span class="number">300</span></span><br><span class="line">    frame #<span class="number">15</span>: <span class="number">0x00000001d03c2650</span> UIKitCore`-[_UIWindowRotationAnimationController animateTransition:] + <span class="number">456</span></span><br><span class="line">    frame #<span class="number">16</span>: <span class="number">0x00000001d0968398</span> UIKitCore`-[UIWindow _rotateToBounds:withAnimator:transitionContext:] + <span class="number">580</span></span><br><span class="line">    frame #<span class="number">17</span>: <span class="number">0x00000001d096aafc</span> UIKitCore`-[UIWindow _rotateWindowToOrientation:updateStatusBar:duration:skipCallbacks:] + <span class="number">1184</span></span><br><span class="line">    frame #<span class="number">18</span>: <span class="number">0x00000001d096b1b0</span> UIKitCore`-[UIWindow _setRotatableClient:toOrientation:updateStatusBar:duration:force:isRotating:] + <span class="number">516</span></span><br><span class="line">    frame #<span class="number">19</span>: <span class="number">0x00000001d096a5b0</span> UIKitCore`-[UIWindow _setRotatableViewOrientation:updateStatusBar:duration:force:] + <span class="number">128</span></span><br><span class="line">    frame #<span class="number">20</span>: <span class="number">0x00000001d096925c</span> UIKitCore`__57-[UIWindow _updateToInterfaceOrientation:duration:force:]_block_invoke + <span class="number">124</span></span><br><span class="line">    frame #<span class="number">21</span>: <span class="number">0x00000001d0969160</span> UIKitCore`-[UIWindow _updateToInterfaceOrientation:duration:force:] + <span class="number">560</span></span><br><span class="line">    frame #<span class="number">22</span>: <span class="number">0x00000001a43595bc</span> CoreFoundation`__CFNOTIFICATIONCENTER_IS_CALLING_OUT_TO_AN_OBSERVER__ + <span class="number">20</span></span><br><span class="line">    frame #<span class="number">23</span>: <span class="number">0x00000001a4359588</span> CoreFoundation`___CFXRegistrationPost_block_invoke + <span class="number">64</span></span><br><span class="line">    frame #<span class="number">24</span>: <span class="number">0x00000001a4358a7c</span> CoreFoundation`_CFXRegistrationPost + <span class="number">392</span></span><br><span class="line">    frame #<span class="number">25</span>: <span class="number">0x00000001a4358728</span> CoreFoundation`___CFXNotificationPost_block_invoke + <span class="number">96</span></span><br><span class="line">    frame #<span class="number">26</span>: <span class="number">0x00000001a42d2524</span> CoreFoundation`-[_CFXNotificationRegistrar find:object:observer:enumerator:] + <span class="number">1496</span></span><br><span class="line">    frame #<span class="number">27</span>: <span class="number">0x00000001a43581d8</span> CoreFoundation`_CFXNotificationPost + <span class="number">696</span></span><br><span class="line">    frame #<span class="number">28</span>: <span class="number">0x00000001a4d40814</span> Foundation`-[NSNotificationCenter postNotificationName:object:userInfo:] + <span class="number">68</span></span><br><span class="line">    frame #<span class="number">29</span>: <span class="number">0x00000001d05c2030</span> UIKitCore`-[UIDevice setOrientation:animated:] + <span class="number">328</span></span><br><span class="line">    frame #<span class="number">30</span>: <span class="number">0x00000001d01f071c</span> UIKitCore`__124-[_UICanvasDeviceOrientationSettingsDiffAction _updateDeviceOrientationWithSettingObserverContext:canvas:transitionContext:]_block_invoke + <span class="number">88</span></span><br><span class="line">    frame #<span class="number">31</span>: <span class="number">0x00000001d01f2304</span> UIKitCore`_performChangesWithTransitionContext + <span class="number">836</span></span><br><span class="line">    frame #<span class="number">32</span>: <span class="number">0x00000001d01f0688</span> UIKitCore`-[_UICanvasDeviceOrientationSettingsDiffAction _updateDeviceOrientationWithSettingObserverContext:canvas:transitionContext:] + <span class="number">236</span></span><br><span class="line">    frame #<span class="number">33</span>: <span class="number">0x00000001d01f058c</span> UIKitCore`__133-[_UICanvasDeviceOrientationSettingsDiffAction performActionsForCanvas:withUpdatedScene:settingsDiff:fromSettings:transitionContext:]_block_invoke + <span class="number">104</span></span><br><span class="line">    frame #<span class="number">34</span>: <span class="number">0x00000001d01f1fb0</span> UIKitCore`_performActionsWithDelayForTransitionContext + <span class="number">112</span></span><br><span class="line">    frame #<span class="number">35</span>: <span class="number">0x00000001d01f04e0</span> UIKitCore`-[_UICanvasDeviceOrientationSettingsDiffAction performActionsForCanvas:withUpdatedScene:settingsDiff:fromSettings:transitionContext:] + <span class="number">172</span></span><br><span class="line">    frame #<span class="number">36</span>: <span class="number">0x00000001d01f5d84</span> UIKitCore`-[_UICanvas scene:didUpdateWithDiff:transitionContext:completion:] + <span class="number">360</span></span><br><span class="line">    frame #<span class="number">37</span>: <span class="number">0x00000001d05253b8</span> UIKitCore`-[UIApplicationSceneClientAgent scene:handleEvent:withCompletion:] + <span class="number">464</span></span><br><span class="line">    frame #<span class="number">38</span>: <span class="number">0x00000001a6d63920</span> FrontBoardServices`__80-[FBSSceneImpl updater:didUpdateSettings:withDiff:transitionContext:completion:]_block_invoke_3 + <span class="number">224</span></span><br><span class="line">    frame #<span class="number">39</span>: <span class="number">0x00000001356e4c74</span> libdispatch.dylib`_dispatch_client_callout + <span class="number">16</span></span><br><span class="line">    frame #<span class="number">40</span>: <span class="number">0x00000001356e8840</span> libdispatch.dylib`_dispatch_block_invoke_direct + <span class="number">232</span></span><br><span class="line">    frame #<span class="number">41</span>: <span class="number">0x00000001a6d9d0bc</span> FrontBoardServices`__FBSSERIALQUEUE_IS_CALLING_OUT_TO_A_BLOCK__ + <span class="number">40</span></span><br><span class="line">    frame #<span class="number">42</span>: <span class="number">0x00000001a6d9cd58</span> FrontBoardServices`-[FBSSerialQueue _performNext] + <span class="number">408</span></span><br><span class="line">    frame #<span class="number">43</span>: <span class="number">0x00000001a6d9d310</span> FrontBoardServices`-[FBSSerialQueue _performNextFromRunLoopSource] + <span class="number">52</span></span><br><span class="line">    frame #<span class="number">44</span>: <span class="number">0x00000001a437a2bc</span> CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + <span class="number">24</span></span><br><span class="line">    frame #<span class="number">45</span>: <span class="number">0x00000001a437a23c</span> CoreFoundation`__CFRunLoopDoSource0 + <span class="number">88</span></span><br><span class="line">    frame #<span class="number">46</span>: <span class="number">0x00000001a4379b24</span> CoreFoundation`__CFRunLoopDoSources0 + <span class="number">176</span></span><br><span class="line">    frame #<span class="number">47</span>: <span class="number">0x00000001a4374a60</span> CoreFoundation`__CFRunLoopRun + <span class="number">1004</span></span><br><span class="line">    frame #<span class="number">48</span>: <span class="number">0x00000001a4374354</span> CoreFoundation`CFRunLoopRunSpecific + <span class="number">436</span></span><br><span class="line">    frame #<span class="number">49</span>: <span class="number">0x00000001a657479c</span> GraphicsServices`GSEventRunModal + <span class="number">104</span></span><br><span class="line">    frame #<span class="number">50</span>: <span class="number">0x00000001d092bb68</span> UIKitCore`UIApplicationMain + <span class="number">212</span></span><br><span class="line">    frame #<span class="number">51</span>: <span class="number">0x000000010525d370</span> Glip`main at AppDelegate.swift:<span class="number">67</span>:<span class="number">7</span></span><br><span class="line">    frame #<span class="number">52</span>: <span class="number">0x00000001a3e3a8e0</span> libdyld.dylib`start + <span class="number">4</span></span><br></pre></td></tr></table></figure>
<p>最后通过断点定位，发现问题出在</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">frame #<span class="number">22</span>: <span class="number">0x00000001a43595bc</span> CoreFoundation`__CFNOTIFICATIONCENTER_IS_CALLING_OUT_TO_AN_OBSERVER__ + <span class="number">20</span></span><br><span class="line">frame #<span class="number">23</span>: <span class="number">0x00000001a4359588</span> CoreFoundation`___CFXRegistrationPost_block_invoke + <span class="number">64</span></span><br><span class="line">frame #<span class="number">24</span>: <span class="number">0x00000001a4358a7c</span> CoreFoundation`_CFXRegistrationPost + <span class="number">392</span></span><br><span class="line">frame #<span class="number">25</span>: <span class="number">0x00000001a4358728</span> CoreFoundation`___CFXNotificationPost_block_invoke + <span class="number">96</span></span><br><span class="line">frame #<span class="number">26</span>: <span class="number">0x00000001a42d2524</span> CoreFoundation`-[_CFXNotificationRegistrar find:object:observer:enumerator:] + <span class="number">1496</span></span><br><span class="line">frame #<span class="number">27</span>: <span class="number">0x00000001a43581d8</span> CoreFoundation`_CFXNotificationPost + <span class="number">696</span></span><br><span class="line">frame #<span class="number">28</span>: <span class="number">0x00000001a4d40814</span> Foundation`-[NSNotificationCenter postNotificationName:object:userInfo:] + <span class="number">68</span></span><br><span class="line">frame #<span class="number">29</span>: <span class="number">0x00000001d05c2030</span> UIKitCore`-[UIDevice setOrientation:animated:] + <span class="number">328</span></span><br></pre></td></tr></table></figure>
<p>不论APP是否支持旋转，<code>[UIDevice setOrientation:animated:]</code> 都会调用，且参数值也是对的。关键在于下一步，当APP支持旋转的时候，会发出一个<code>UIDeviceOrientationDidChangeNotification</code> 通知，不支持旋转的时候就不会。</p>
<p>于是问题就转化成了：什么情况下，系统有可能会不发出 <code>UIDeviceOrientationDidChangeNotification</code> 通知呢？</p>
<p>遇事不决，看文档。</p>
<p>在 <code>UIDevice.h</code> 中找到这三个玩意儿</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">readonly</span>,<span class="keyword">getter</span>=isGeneratingDeviceOrientationNotifications) <span class="built_in">BOOL</span> generatesDeviceOrientationNotifications __TVOS_PROHIBITED;</span><br><span class="line">- (<span class="keyword">void</span>)beginGeneratingDeviceOrientationNotifications __TVOS_PROHIBITED;      <span class="comment">// nestable</span></span><br><span class="line">- (<span class="keyword">void</span>)endGeneratingDeviceOrientationNotifications __TVOS_PROHIBITED;</span><br></pre></td></tr></table></figure>
<p>看着应该就是罪魁祸首了。</p>
<h2 id="定位问题"><a href="#定位问题" class="headerlink" title="定位问题"></a>定位问题</h2><p>调试发现，在APP支持旋转时 <code>isGeneratingDeviceOrientationNotifications = true</code>；<br>不支持时  <code>isGeneratingDeviceOrientationNotifications=false</code>。</p>
<p>查看 <code>generatesDeviceOrientationNotifications</code> 文档：</p>
<blockquote>
<p>If the value of this property is YES, the shared UIDevice object posts a UIDeviceOrientationDidChangeNotification notification when the device changes orientation. If the value is NO, it generates no orientation notifications. Device orientation notifications can only be generated between calls to the beginGeneratingDeviceOrientationNotifications and endGeneratingDeviceOrientationNotifications methods.</p>
</blockquote>
<p>查看 <code>beginGeneratingDeviceOrientationNotifications</code> 文档：</p>
<blockquote>
<p>You must call this method before attempting to get orientation data from the receiver. This method enables the device’s accelerometer hardware and begins the delivery of acceleration events to the receiver. The receiver subsequently uses these events to post UIDeviceOrientationDidChangeNotification notifications when the device orientation changes and to update the orientation property.<br>You may nest calls to this method safely, but you should always match each call with a corresponding call to the endGeneratingDeviceOrientationNotifications method.</p>
</blockquote>
<p>所以 <code>isGeneratingDeviceOrientationNotifications</code> 的值是受另外两个方法影响的。</p>
<p><strong>看来已经找到原因了</strong></p>
<p>继续调试发现，项目代码内部并没有调用到 <code>beginGeneratingDeviceOrientationNotifications</code> 和 <code>endGeneratingDeviceOrientationNotifications</code>。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>当 <code>-[UIWindow setRootViewController:]</code>的时候，系统会调用 <code>beginGeneratingDeviceOrientationNotifications</code>，当 <code>-[UIWindow dealloc]</code> 时，会调用 <code>endGeneratingDeviceOrientationNotifications</code>，这么看系统的这个逻辑是没什么问题的。<br>问题出在于 WebRTC 中，在 start video session 的时候有调用 <code>beginGeneratingDeviceOrientationNotifications</code>，stop video session 的时候有调用 <code>endGeneratingDeviceOrientationNotifications</code>。但是CoreLib里的代码有点问题，start video session 的时候并没有调用 <code>beginGeneratingDeviceOrientationNotifications</code> ，导致这两个没有成对出现，从而出错。</p>
<p>以前没有特别关注过这三者：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">readonly</span>,<span class="keyword">getter</span>=isGeneratingDeviceOrientationNotifications) <span class="built_in">BOOL</span> generatesDeviceOrientationNotifications __TVOS_PROHIBITED;</span><br><span class="line">- (<span class="keyword">void</span>)beginGeneratingDeviceOrientationNotifications __TVOS_PROHIBITED;      <span class="comment">// nestable</span></span><br><span class="line">- (<span class="keyword">void</span>)endGeneratingDeviceOrientationNotifications __TVOS_PROHIBITED;</span><br></pre></td></tr></table></figure>
<p>以后遇到旋转问题，又多了一条思路了..</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">home</a></li>
         
          <li><a href="/buddy/">links</a></li>
         
          <li><a href="/about/">about</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#现象"><span class="toc-number">1.</span> <span class="toc-text">现象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#猜测"><span class="toc-number">2.</span> <span class="toc-text">猜测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#猜测1⃣️"><span class="toc-number">2.1.</span> <span class="toc-text">猜测1⃣️</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#猜测2⃣️"><span class="toc-number">2.2.</span> <span class="toc-text">猜测2⃣️</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#寻找思路"><span class="toc-number">3.</span> <span class="toc-text">寻找思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定位问题"><span class="toc-number">4.</span> <span class="toc-text">定位问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结论"><span class="toc-number">5.</span> <span class="toc-text">结论</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://shixiong.name/2019/07/30/find-a-wierd-bug/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://shixiong.name/2019/07/30/find-a-wierd-bug/&text=一个奇怪的旋转问题"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://shixiong.name/2019/07/30/find-a-wierd-bug/&title=一个奇怪的旋转问题"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://shixiong.name/2019/07/30/find-a-wierd-bug/&is_video=false&description=一个奇怪的旋转问题"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=一个奇怪的旋转问题&body=Check out this article: https://shixiong.name/2019/07/30/find-a-wierd-bug/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://shixiong.name/2019/07/30/find-a-wierd-bug/&title=一个奇怪的旋转问题"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://shixiong.name/2019/07/30/find-a-wierd-bug/&title=一个奇怪的旋转问题"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://shixiong.name/2019/07/30/find-a-wierd-bug/&title=一个奇怪的旋转问题"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://shixiong.name/2019/07/30/find-a-wierd-bug/&title=一个奇怪的旋转问题"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://shixiong.name/2019/07/30/find-a-wierd-bug/&name=一个奇怪的旋转问题&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2022 Mario
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">home</a></li>
         
          <li><a href="/buddy/">links</a></li>
         
          <li><a href="/about/">about</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-74077474-2', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'shixiong-name';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


