<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000">
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top">
  
  
  <title>一个奇怪的旋转问题 | Daemon</title>
  <meta name="description" content="现象最近发现一个很神奇的bug，加入某个会议之后然后退出，重复3次，界面就无法旋转了。 猜测猜测1⃣️无法旋转，在确认旋转锁定关闭的情况下，第一个想法是，看看support orientation 相关的函数返回值是否正确。 12345func application(_ application: UIApplication, supportedInterfaceOrientationsFor w">
<meta name="keywords" content="iOS,Orientation">
<meta property="og:type" content="article">
<meta property="og:title" content="一个奇怪的旋转问题">
<meta property="og:url" content="https://shixiong.name/2019/07/30/find-a-wierd-bug/index.html">
<meta property="og:site_name" content="Daemon">
<meta property="og:description" content="现象最近发现一个很神奇的bug，加入某个会议之后然后退出，重复3次，界面就无法旋转了。 猜测猜测1⃣️无法旋转，在确认旋转锁定关闭的情况下，第一个想法是，看看support orientation 相关的函数返回值是否正确。 12345func application(_ application: UIApplication, supportedInterfaceOrientationsFor w">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-07-31T08:41:19.847Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一个奇怪的旋转问题">
<meta name="twitter:description" content="现象最近发现一个很神奇的bug，加入某个会议之后然后退出，重复3次，界面就无法旋转了。 猜测猜测1⃣️无法旋转，在确认旋转锁定关闭的情况下，第一个想法是，看看support orientation 相关的函数返回值是否正确。 12345func application(_ application: UIApplication, supportedInterfaceOrientationsFor w">
  <!-- Canonical links -->
  <link rel="canonical" href="https://shixiong.name/2019/07/30/find-a-wierd-bug/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Daemon" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
  
  
</head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope="" itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/imsuperman" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.png" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">Daemon</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">iOS Developer</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Xiamen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索">
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech="">
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope="" itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-nag">
          <a href="/nag">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">唠叨</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">友链</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/imsuperman" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li>
        
        <li><a href="https://twitter.com/_iamdaemon" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope="" itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">关于</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>Make simple things to simple, make complex things to possible.</p>
            </div>
        </div>
    </div>
</div>

    
      

    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ARTS/">ARTS</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flask/">Flask</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Method-Swizzling/">Method Swizzling</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Objective-C/">Objective-C</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenSSL/">OpenSSL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Orientation/">Orientation</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Runtime/">Runtime</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swift/">Swift</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS/">iOS</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sublime-text/">sublime text</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/动画/">动画</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/心得/">心得</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/贝塞尔/">贝塞尔</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/软件工程/">软件工程</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/ARTS/" style="font-size: 13.5px;">ARTS</a> <a href="/tags/Flask/" style="font-size: 13px;">Flask</a> <a href="/tags/Linux/" style="font-size: 13px;">Linux</a> <a href="/tags/Method-Swizzling/" style="font-size: 13px;">Method Swizzling</a> <a href="/tags/Objective-C/" style="font-size: 13px;">Objective-C</a> <a href="/tags/OpenSSL/" style="font-size: 13px;">OpenSSL</a> <a href="/tags/Orientation/" style="font-size: 13px;">Orientation</a> <a href="/tags/Python/" style="font-size: 13px;">Python</a> <a href="/tags/Runtime/" style="font-size: 13px;">Runtime</a> <a href="/tags/Swift/" style="font-size: 13px;">Swift</a> <a href="/tags/iOS/" style="font-size: 14px;">iOS</a> <a href="/tags/sublime-text/" style="font-size: 13px;">sublime text</a> <a href="/tags/动画/" style="font-size: 13px;">动画</a> <a href="/tags/心得/" style="font-size: 13px;">心得</a> <a href="/tags/贝塞尔/" style="font-size: 13px;">贝塞尔</a> <a href="/tags/软件工程/" style="font-size: 13px;">软件工程</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2019/07/30/find-a-wierd-bug/" class="title">一个奇怪的旋转问题</a>
              </p>
              <p class="item-date">
                <time datetime="2019-07-30T02:24:32.000Z" itemprop="datePublished">2019-07-30</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2019/03/29/note-to-myself-on-software-engineering/" class="title">【译】写给自己的软件工程笔记</a>
              </p>
              <p class="item-date">
                <time datetime="2019-03-29T08:53:45.000Z" itemprop="datePublished">2019-03-29</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2019/03/29/arts-second-week/" class="title">ARTS挑战-第二周</a>
              </p>
              <p class="item-date">
                <time datetime="2019-03-29T08:16:23.000Z" itemprop="datePublished">2019-03-29</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2019/03/25/arts-first-week/" class="title">ARTS挑战-第一周</a>
              </p>
              <p class="item-date">
                <time datetime="2019-03-25T08:25:19.000Z" itemprop="datePublished">2019-03-25</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2019/03/01/the-right-way-to-swizzling/" class="title">探究使用Method Swizzling的正确姿势</a>
              </p>
              <p class="item-date">
                <time datetime="2019-03-01T03:07:43.000Z" itemprop="datePublished">2019-03-01</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-find-a-wierd-bug" class="article article-type-post" itemscope="" itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      一个奇怪的旋转问题
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2019/07/30/find-a-wierd-bug/" class="article-date">
	  <time datetime="2019-07-30T02:24:32.000Z" itemprop="datePublished">2019-07-30</time>
	</a>
</span>
        
        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/Orientation/">Orientation</a>, <a class="article-tag-link" href="/tags/iOS/">iOS</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2019/07/30/find-a-wierd-bug/#comments" class="article-comment-link">评论</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>最近发现一个很神奇的bug，加入某个会议之后然后退出，重复3次，界面就无法旋转了。</p>
<h2 id="猜测"><a href="#猜测" class="headerlink" title="猜测"></a>猜测</h2><h3 id="猜测1⃣️"><a href="#猜测1⃣️" class="headerlink" title="猜测1⃣️"></a>猜测1⃣️</h3><p>无法旋转，在确认旋转锁定关闭的情况下，第一个想法是，看看support orientation 相关的函数返回值是否正确。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">func application(_ application: UIApplication, supportedInterfaceOrientationsFor window: UIWindow?) -&gt; UIInterfaceOrientationMask</span><br><span class="line"></span><br><span class="line">open override var shouldAutorotate: Bool </span><br><span class="line"></span><br><span class="line">open override var supportedInterfaceOrientations: UIInterfaceOrientationMask</span><br></pre></td></tr></table></figure>
<p>于是打了三个全局断点，一个一个调试…</p>
<p>果不其然…<br>都<strong>没什么问题</strong>…</p>
<p>但是这里有个现象，当出现bug（即无法旋转）的时候，这些函数都不会被调用了。</p>
<h3 id="猜测2⃣️"><a href="#猜测2⃣️" class="headerlink" title="猜测2⃣️"></a>猜测2⃣️</h3><p>如果不是支持方向不对的话，回头看了一下现象：重复三次…<br>于是继续猜测，会不会跟内存泄漏有关，之前有遇到过内存相关问题的现象也是重复操作n次出现。</p>
<p>于是调试了一下…</p>
<p>果不其然…<br>还是<strong>没什么问题</strong>…</p>
<h2 id="寻找思路"><a href="#寻找思路" class="headerlink" title="寻找思路"></a>寻找思路</h2><p>前面的猜测都不对，一下子就懵逼了，毫无头绪。后来仔细想了想，要不试试从系统接口找找问题，既然要旋转，最后肯定会落地到系统层面的某个方法上。</p>
<p>于是打了个断点在 <code>-[UIViewController shouldAutorotate]</code></p>
<p>当设备可以旋转的时候，调用栈如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1</span><br><span class="line">  * frame #<span class="number">0</span>: <span class="number">0x00000001d039de80</span> UIKitCore`-[UIViewController shouldAutorotate]</span><br><span class="line">    frame #<span class="number">1</span>: <span class="number">0x00000001d039f8b8</span> UIKitCore`-[UIViewController _updateLastKnownInterfaceOrientationOnPresentionStack:] + <span class="number">144</span></span><br><span class="line">    frame #<span class="number">2</span>: <span class="number">0x00000001d03a0e84</span> UIKitCore`-[UIViewController window:willAnimateRotationToInterfaceOrientation:duration:newSize:] + <span class="number">92</span></span><br><span class="line">    frame #<span class="number">3</span>: <span class="number">0x00000001d03a8270</span> UIKitCore`__95-[UIViewController(AdaptiveSizing) _window:viewWillTransitionToSize:withTransitionCoordinator:]_block_invoke<span class="number">.3392</span> + <span class="number">48</span></span><br><span class="line">    frame #<span class="number">4</span>: <span class="number">0x00000001d03af570</span> UIKitCore`-[_UIViewControllerTransitionCoordinator _applyBlocks:releaseBlocks:] + <span class="number">264</span></span><br><span class="line">    frame #<span class="number">5</span>: <span class="number">0x00000001d03abb64</span> UIKitCore`-[_UIViewControllerTransitionContext __runAlongsideAnimations] + <span class="number">176</span></span><br><span class="line">    frame #<span class="number">6</span>: <span class="number">0x00000001d0da7f40</span> UIKitCore`+[UIView(UIViewAnimationWithBlocks) _setupAnimationWithDuration:delay:view:options:factory:animations:start:animationStateGenerator:completion:] + <span class="number">608</span></span><br><span class="line">    frame #<span class="number">7</span>: <span class="number">0x00000001d0da8480</span> UIKitCore`+[UIView(UIViewAnimationWithBlocks) animateWithDuration:delay:options:animations:completion:] + <span class="number">108</span></span><br><span class="line">    frame #<span class="number">8</span>: <span class="number">0x000000010710a74c</span> Glip`+[UIView(instrumentation) ADEumAnimateWithDuration:delay:options:animations:completion:] + <span class="number">300</span></span><br><span class="line">    frame #<span class="number">9</span>: <span class="number">0x00000001d03c29e8</span> UIKitCore`__58-[_UIWindowRotationAnimationController animateTransition:]_block_invoke_2 + <span class="number">308</span></span><br><span class="line">    frame #<span class="number">10</span>: <span class="number">0x00000001d0dac560</span> UIKitCore`+[UIView(Internal) _performBlockDelayingTriggeringResponderEvents:] + <span class="number">220</span></span><br><span class="line">    frame #<span class="number">11</span>: <span class="number">0x00000001d03c2778</span> UIKitCore`__58-[_UIWindowRotationAnimationController animateTransition:]_block_invoke + <span class="number">128</span></span><br><span class="line">    frame #<span class="number">12</span>: <span class="number">0x00000001d0da7f40</span> UIKitCore`+[UIView(UIViewAnimationWithBlocks) _setupAnimationWithDuration:delay:view:options:factory:animations:start:animationStateGenerator:completion:] + <span class="number">608</span></span><br><span class="line">    frame #<span class="number">13</span>: <span class="number">0x00000001d0da8480</span> UIKitCore`+[UIView(UIViewAnimationWithBlocks) animateWithDuration:delay:options:animations:completion:] + <span class="number">108</span></span><br><span class="line">    frame #<span class="number">14</span>: <span class="number">0x000000010710a74c</span> Glip`+[UIView(instrumentation) ADEumAnimateWithDuration:delay:options:animations:completion:] + <span class="number">300</span></span><br><span class="line">    frame #<span class="number">15</span>: <span class="number">0x00000001d03c2650</span> UIKitCore`-[_UIWindowRotationAnimationController animateTransition:] + <span class="number">456</span></span><br><span class="line">    frame #<span class="number">16</span>: <span class="number">0x00000001d0968398</span> UIKitCore`-[UIWindow _rotateToBounds:withAnimator:transitionContext:] + <span class="number">580</span></span><br><span class="line">    frame #<span class="number">17</span>: <span class="number">0x00000001d096aafc</span> UIKitCore`-[UIWindow _rotateWindowToOrientation:updateStatusBar:duration:skipCallbacks:] + <span class="number">1184</span></span><br><span class="line">    frame #<span class="number">18</span>: <span class="number">0x00000001d096b1b0</span> UIKitCore`-[UIWindow _setRotatableClient:toOrientation:updateStatusBar:duration:force:isRotating:] + <span class="number">516</span></span><br><span class="line">    frame #<span class="number">19</span>: <span class="number">0x00000001d096a5b0</span> UIKitCore`-[UIWindow _setRotatableViewOrientation:updateStatusBar:duration:force:] + <span class="number">128</span></span><br><span class="line">    frame #<span class="number">20</span>: <span class="number">0x00000001d096925c</span> UIKitCore`__57-[UIWindow _updateToInterfaceOrientation:duration:force:]_block_invoke + <span class="number">124</span></span><br><span class="line">    frame #<span class="number">21</span>: <span class="number">0x00000001d0969160</span> UIKitCore`-[UIWindow _updateToInterfaceOrientation:duration:force:] + <span class="number">560</span></span><br><span class="line">    frame #<span class="number">22</span>: <span class="number">0x00000001a43595bc</span> CoreFoundation`__CFNOTIFICATIONCENTER_IS_CALLING_OUT_TO_AN_OBSERVER__ + <span class="number">20</span></span><br><span class="line">    frame #<span class="number">23</span>: <span class="number">0x00000001a4359588</span> CoreFoundation`___CFXRegistrationPost_block_invoke + <span class="number">64</span></span><br><span class="line">    frame #<span class="number">24</span>: <span class="number">0x00000001a4358a7c</span> CoreFoundation`_CFXRegistrationPost + <span class="number">392</span></span><br><span class="line">    frame #<span class="number">25</span>: <span class="number">0x00000001a4358728</span> CoreFoundation`___CFXNotificationPost_block_invoke + <span class="number">96</span></span><br><span class="line">    frame #<span class="number">26</span>: <span class="number">0x00000001a42d2524</span> CoreFoundation`-[_CFXNotificationRegistrar find:object:observer:enumerator:] + <span class="number">1496</span></span><br><span class="line">    frame #<span class="number">27</span>: <span class="number">0x00000001a43581d8</span> CoreFoundation`_CFXNotificationPost + <span class="number">696</span></span><br><span class="line">    frame #<span class="number">28</span>: <span class="number">0x00000001a4d40814</span> Foundation`-[NSNotificationCenter postNotificationName:object:userInfo:] + <span class="number">68</span></span><br><span class="line">    frame #<span class="number">29</span>: <span class="number">0x00000001d05c2030</span> UIKitCore`-[UIDevice setOrientation:animated:] + <span class="number">328</span></span><br><span class="line">    frame #<span class="number">30</span>: <span class="number">0x00000001d01f071c</span> UIKitCore`__124-[_UICanvasDeviceOrientationSettingsDiffAction _updateDeviceOrientationWithSettingObserverContext:canvas:transitionContext:]_block_invoke + <span class="number">88</span></span><br><span class="line">    frame #<span class="number">31</span>: <span class="number">0x00000001d01f2304</span> UIKitCore`_performChangesWithTransitionContext + <span class="number">836</span></span><br><span class="line">    frame #<span class="number">32</span>: <span class="number">0x00000001d01f0688</span> UIKitCore`-[_UICanvasDeviceOrientationSettingsDiffAction _updateDeviceOrientationWithSettingObserverContext:canvas:transitionContext:] + <span class="number">236</span></span><br><span class="line">    frame #<span class="number">33</span>: <span class="number">0x00000001d01f058c</span> UIKitCore`__133-[_UICanvasDeviceOrientationSettingsDiffAction performActionsForCanvas:withUpdatedScene:settingsDiff:fromSettings:transitionContext:]_block_invoke + <span class="number">104</span></span><br><span class="line">    frame #<span class="number">34</span>: <span class="number">0x00000001d01f1fb0</span> UIKitCore`_performActionsWithDelayForTransitionContext + <span class="number">112</span></span><br><span class="line">    frame #<span class="number">35</span>: <span class="number">0x00000001d01f04e0</span> UIKitCore`-[_UICanvasDeviceOrientationSettingsDiffAction performActionsForCanvas:withUpdatedScene:settingsDiff:fromSettings:transitionContext:] + <span class="number">172</span></span><br><span class="line">    frame #<span class="number">36</span>: <span class="number">0x00000001d01f5d84</span> UIKitCore`-[_UICanvas scene:didUpdateWithDiff:transitionContext:completion:] + <span class="number">360</span></span><br><span class="line">    frame #<span class="number">37</span>: <span class="number">0x00000001d05253b8</span> UIKitCore`-[UIApplicationSceneClientAgent scene:handleEvent:withCompletion:] + <span class="number">464</span></span><br><span class="line">    frame #<span class="number">38</span>: <span class="number">0x00000001a6d63920</span> FrontBoardServices`__80-[FBSSceneImpl updater:didUpdateSettings:withDiff:transitionContext:completion:]_block_invoke_3 + <span class="number">224</span></span><br><span class="line">    frame #<span class="number">39</span>: <span class="number">0x00000001356e4c74</span> libdispatch.dylib`_dispatch_client_callout + <span class="number">16</span></span><br><span class="line">    frame #<span class="number">40</span>: <span class="number">0x00000001356e8840</span> libdispatch.dylib`_dispatch_block_invoke_direct + <span class="number">232</span></span><br><span class="line">    frame #<span class="number">41</span>: <span class="number">0x00000001a6d9d0bc</span> FrontBoardServices`__FBSSERIALQUEUE_IS_CALLING_OUT_TO_A_BLOCK__ + <span class="number">40</span></span><br><span class="line">    frame #<span class="number">42</span>: <span class="number">0x00000001a6d9cd58</span> FrontBoardServices`-[FBSSerialQueue _performNext] + <span class="number">408</span></span><br><span class="line">    frame #<span class="number">43</span>: <span class="number">0x00000001a6d9d310</span> FrontBoardServices`-[FBSSerialQueue _performNextFromRunLoopSource] + <span class="number">52</span></span><br><span class="line">    frame #<span class="number">44</span>: <span class="number">0x00000001a437a2bc</span> CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + <span class="number">24</span></span><br><span class="line">    frame #<span class="number">45</span>: <span class="number">0x00000001a437a23c</span> CoreFoundation`__CFRunLoopDoSource0 + <span class="number">88</span></span><br><span class="line">    frame #<span class="number">46</span>: <span class="number">0x00000001a4379b24</span> CoreFoundation`__CFRunLoopDoSources0 + <span class="number">176</span></span><br><span class="line">    frame #<span class="number">47</span>: <span class="number">0x00000001a4374a60</span> CoreFoundation`__CFRunLoopRun + <span class="number">1004</span></span><br><span class="line">    frame #<span class="number">48</span>: <span class="number">0x00000001a4374354</span> CoreFoundation`CFRunLoopRunSpecific + <span class="number">436</span></span><br><span class="line">    frame #<span class="number">49</span>: <span class="number">0x00000001a657479c</span> GraphicsServices`GSEventRunModal + <span class="number">104</span></span><br><span class="line">    frame #<span class="number">50</span>: <span class="number">0x00000001d092bb68</span> UIKitCore`UIApplicationMain + <span class="number">212</span></span><br><span class="line">    frame #<span class="number">51</span>: <span class="number">0x000000010525d370</span> Glip`main at AppDelegate.swift:<span class="number">67</span>:<span class="number">7</span></span><br><span class="line">    frame #<span class="number">52</span>: <span class="number">0x00000001a3e3a8e0</span> libdyld.dylib`start + <span class="number">4</span></span><br></pre></td></tr></table></figure>
<p>最后通过断点定位，发现问题出在</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">frame #<span class="number">22</span>: <span class="number">0x00000001a43595bc</span> CoreFoundation`__CFNOTIFICATIONCENTER_IS_CALLING_OUT_TO_AN_OBSERVER__ + <span class="number">20</span></span><br><span class="line">frame #<span class="number">23</span>: <span class="number">0x00000001a4359588</span> CoreFoundation`___CFXRegistrationPost_block_invoke + <span class="number">64</span></span><br><span class="line">frame #<span class="number">24</span>: <span class="number">0x00000001a4358a7c</span> CoreFoundation`_CFXRegistrationPost + <span class="number">392</span></span><br><span class="line">frame #<span class="number">25</span>: <span class="number">0x00000001a4358728</span> CoreFoundation`___CFXNotificationPost_block_invoke + <span class="number">96</span></span><br><span class="line">frame #<span class="number">26</span>: <span class="number">0x00000001a42d2524</span> CoreFoundation`-[_CFXNotificationRegistrar find:object:observer:enumerator:] + <span class="number">1496</span></span><br><span class="line">frame #<span class="number">27</span>: <span class="number">0x00000001a43581d8</span> CoreFoundation`_CFXNotificationPost + <span class="number">696</span></span><br><span class="line">frame #<span class="number">28</span>: <span class="number">0x00000001a4d40814</span> Foundation`-[NSNotificationCenter postNotificationName:object:userInfo:] + <span class="number">68</span></span><br><span class="line">frame #<span class="number">29</span>: <span class="number">0x00000001d05c2030</span> UIKitCore`-[UIDevice setOrientation:animated:] + <span class="number">328</span></span><br></pre></td></tr></table></figure>
<p>不论APP是否支持旋转，<code>[UIDevice setOrientation:animated:]</code> 都会调用，且参数值也是对的。关键在于下一步，当APP支持旋转的时候，会发出一个<code>UIDeviceOrientationDidChangeNotification</code> 通知，不支持旋转的时候就不会。</p>
<p>于是问题就转化成了：什么情况下，系统有可能会不发出 <code>UIDeviceOrientationDidChangeNotification</code> 通知呢？</p>
<p>遇事不决，看文档。</p>
<p>在 <code>UIDevice.h</code> 中找到这三个玩意儿</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">readonly</span>,<span class="keyword">getter</span>=isGeneratingDeviceOrientationNotifications) <span class="built_in">BOOL</span> generatesDeviceOrientationNotifications __TVOS_PROHIBITED;</span><br><span class="line">- (<span class="keyword">void</span>)beginGeneratingDeviceOrientationNotifications __TVOS_PROHIBITED;      <span class="comment">// nestable</span></span><br><span class="line">- (<span class="keyword">void</span>)endGeneratingDeviceOrientationNotifications __TVOS_PROHIBITED;</span><br></pre></td></tr></table></figure>
<p>看着应该就是罪魁祸首了。</p>
<h2 id="定位问题"><a href="#定位问题" class="headerlink" title="定位问题"></a>定位问题</h2><p>调试发现，在APP支持旋转时 <code>isGeneratingDeviceOrientationNotifications = true</code>；<br>不支持时  <code>isGeneratingDeviceOrientationNotifications=false</code>。</p>
<p>查看 <code>generatesDeviceOrientationNotifications</code> 文档：</p>
<blockquote>
<p>If the value of this property is YES, the shared UIDevice object posts a UIDeviceOrientationDidChangeNotification notification when the device changes orientation. If the value is NO, it generates no orientation notifications. Device orientation notifications can only be generated between calls to the beginGeneratingDeviceOrientationNotifications and endGeneratingDeviceOrientationNotifications methods.</p>
</blockquote>
<p>查看 <code>beginGeneratingDeviceOrientationNotifications</code> 文档：</p>
<blockquote>
<p>You must call this method before attempting to get orientation data from the receiver. This method enables the device’s accelerometer hardware and begins the delivery of acceleration events to the receiver. The receiver subsequently uses these events to post UIDeviceOrientationDidChangeNotification notifications when the device orientation changes and to update the orientation property.<br>You may nest calls to this method safely, but you should always match each call with a corresponding call to the endGeneratingDeviceOrientationNotifications method.</p>
</blockquote>
<p>所以 <code>isGeneratingDeviceOrientationNotifications</code> 的值是受另外两个方法影响的。</p>
<p><strong>看来已经找到原因了</strong></p>
<p>继续调试发现，项目代码内部并没有调用到 <code>beginGeneratingDeviceOrientationNotifications</code> 和 <code>endGeneratingDeviceOrientationNotifications</code>。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>当 <code>-[UIWindow setRootViewController:]</code>的时候，系统会调用 <code>beginGeneratingDeviceOrientationNotifications</code>，当 <code>-[UIWindow dealloc]</code> 时，会调用 <code>endGeneratingDeviceOrientationNotifications</code>，这么看系统的这个逻辑是没什么问题的。<br>问题出在于 WebRTC 中，在 start video session 的时候有调用 <code>beginGeneratingDeviceOrientationNotifications</code>，stop video session 的时候有调用 <code>endGeneratingDeviceOrientationNotifications</code>。但是CoreLib里的代码有点问题，start video session 的时候并没有调用 <code>beginGeneratingDeviceOrientationNotifications</code> ，导致这两个没有成对出现，从而出错。</p>
<p>以前没有特别关注过这三者：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">readonly</span>,<span class="keyword">getter</span>=isGeneratingDeviceOrientationNotifications) <span class="built_in">BOOL</span> generatesDeviceOrientationNotifications __TVOS_PROHIBITED;</span><br><span class="line">- (<span class="keyword">void</span>)beginGeneratingDeviceOrientationNotifications __TVOS_PROHIBITED;      <span class="comment">// nestable</span></span><br><span class="line">- (<span class="keyword">void</span>)endGeneratingDeviceOrientationNotifications __TVOS_PROHIBITED;</span><br></pre></td></tr></table></figure>
<p>以后遇到旋转问题，又多了一条思路了..</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://shixiong.name/2019/07/30/find-a-wierd-bug/" title="一个奇怪的旋转问题" target="_blank" rel="external">https://shixiong.name/2019/07/30/find-a-wierd-bug/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/imsuperman" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/imsuperman" target="_blank"><span class="text-dark">Daemon</span><small class="ml-1x">iOS Developer</small></a></h3>
        <div>iOS Developer。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom="">
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    
    <li class="next">
      <a href="/2019/03/29/note-to-myself-on-software-engineering/" title="【译】写给自己的软件工程笔记"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope="" itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/imsuperman" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li>
        
        <li><a href="https://twitter.com/_iamdaemon" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="/js/plugin.min.js"></script>
<script src="/js/application.js"></script>

    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>





   




   
    
    <script defer>
    var disqus_config = function () {
        
            this.page.url = 'https://shixiong.name/2019/07/30/find-a-wierd-bug/';
        
        this.page.identifier = 'find-a-wierd-bug';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'shixiong-name' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>






    <script defer type="text/javascript">
(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-74077474-2', 'auto');
ga('send', 'pageview');

</script>



</body>
</html>