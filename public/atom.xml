<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Daemon</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://shixiong.name/"/>
  <updated>2019-07-31T08:41:19.847Z</updated>
  <id>https://shixiong.name/</id>
  
  <author>
    <name>Daemon</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>一个奇怪的旋转问题</title>
    <link href="https://shixiong.name/2019/07/30/find-a-wierd-bug/"/>
    <id>https://shixiong.name/2019/07/30/find-a-wierd-bug/</id>
    <published>2019-07-30T02:24:32.000Z</published>
    <updated>2019-07-31T08:41:19.847Z</updated>
    
    <content type="html"><![CDATA[<h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>最近发现一个很神奇的bug，加入某个会议之后然后退出，重复3次，界面就无法旋转了。</p><h2 id="猜测"><a href="#猜测" class="headerlink" title="猜测"></a>猜测</h2><h3 id="猜测1⃣️"><a href="#猜测1⃣️" class="headerlink" title="猜测1⃣️"></a>猜测1⃣️</h3><p>无法旋转，在确认旋转锁定关闭的情况下，第一个想法是，看看support orientation 相关的函数返回值是否正确。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">func application(_ application: UIApplication, supportedInterfaceOrientationsFor window: UIWindow?) -&gt; UIInterfaceOrientationMask</span><br><span class="line"></span><br><span class="line">open override var shouldAutorotate: Bool </span><br><span class="line"></span><br><span class="line">open override var supportedInterfaceOrientations: UIInterfaceOrientationMask</span><br></pre></td></tr></table></figure><p>于是打了三个全局断点，一个一个调试…</p><p>果不其然…<br>都<strong>没什么问题</strong>…</p><p>但是这里有个现象，当出现bug（即无法旋转）的时候，这些函数都不会被调用了。</p><h3 id="猜测2⃣️"><a href="#猜测2⃣️" class="headerlink" title="猜测2⃣️"></a>猜测2⃣️</h3><p>如果不是支持方向不对的话，回头看了一下现象：重复三次…<br>于是继续猜测，会不会跟内存泄漏有关，之前有遇到过内存相关问题的现象也是重复操作n次出现。</p><p>于是调试了一下…</p><p>果不其然…<br>还是<strong>没什么问题</strong>…</p><h2 id="寻找思路"><a href="#寻找思路" class="headerlink" title="寻找思路"></a>寻找思路</h2><p>前面的猜测都不对，一下子就懵逼了，毫无头绪。后来仔细想了想，要不试试从系统接口找找问题，既然要旋转，最后肯定会落地到系统层面的某个方法上。</p><p>于是打了个断点在 <code>-[UIViewController shouldAutorotate]</code></p><p>当设备可以旋转的时候，调用栈如下:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1</span><br><span class="line">  * frame #<span class="number">0</span>: <span class="number">0x00000001d039de80</span> UIKitCore`-[UIViewController shouldAutorotate]</span><br><span class="line">    frame #<span class="number">1</span>: <span class="number">0x00000001d039f8b8</span> UIKitCore`-[UIViewController _updateLastKnownInterfaceOrientationOnPresentionStack:] + <span class="number">144</span></span><br><span class="line">    frame #<span class="number">2</span>: <span class="number">0x00000001d03a0e84</span> UIKitCore`-[UIViewController window:willAnimateRotationToInterfaceOrientation:duration:newSize:] + <span class="number">92</span></span><br><span class="line">    frame #<span class="number">3</span>: <span class="number">0x00000001d03a8270</span> UIKitCore`__95-[UIViewController(AdaptiveSizing) _window:viewWillTransitionToSize:withTransitionCoordinator:]_block_invoke<span class="number">.3392</span> + <span class="number">48</span></span><br><span class="line">    frame #<span class="number">4</span>: <span class="number">0x00000001d03af570</span> UIKitCore`-[_UIViewControllerTransitionCoordinator _applyBlocks:releaseBlocks:] + <span class="number">264</span></span><br><span class="line">    frame #<span class="number">5</span>: <span class="number">0x00000001d03abb64</span> UIKitCore`-[_UIViewControllerTransitionContext __runAlongsideAnimations] + <span class="number">176</span></span><br><span class="line">    frame #<span class="number">6</span>: <span class="number">0x00000001d0da7f40</span> UIKitCore`+[UIView(UIViewAnimationWithBlocks) _setupAnimationWithDuration:delay:view:options:factory:animations:start:animationStateGenerator:completion:] + <span class="number">608</span></span><br><span class="line">    frame #<span class="number">7</span>: <span class="number">0x00000001d0da8480</span> UIKitCore`+[UIView(UIViewAnimationWithBlocks) animateWithDuration:delay:options:animations:completion:] + <span class="number">108</span></span><br><span class="line">    frame #<span class="number">8</span>: <span class="number">0x000000010710a74c</span> Glip`+[UIView(instrumentation) ADEumAnimateWithDuration:delay:options:animations:completion:] + <span class="number">300</span></span><br><span class="line">    frame #<span class="number">9</span>: <span class="number">0x00000001d03c29e8</span> UIKitCore`__58-[_UIWindowRotationAnimationController animateTransition:]_block_invoke_2 + <span class="number">308</span></span><br><span class="line">    frame #<span class="number">10</span>: <span class="number">0x00000001d0dac560</span> UIKitCore`+[UIView(Internal) _performBlockDelayingTriggeringResponderEvents:] + <span class="number">220</span></span><br><span class="line">    frame #<span class="number">11</span>: <span class="number">0x00000001d03c2778</span> UIKitCore`__58-[_UIWindowRotationAnimationController animateTransition:]_block_invoke + <span class="number">128</span></span><br><span class="line">    frame #<span class="number">12</span>: <span class="number">0x00000001d0da7f40</span> UIKitCore`+[UIView(UIViewAnimationWithBlocks) _setupAnimationWithDuration:delay:view:options:factory:animations:start:animationStateGenerator:completion:] + <span class="number">608</span></span><br><span class="line">    frame #<span class="number">13</span>: <span class="number">0x00000001d0da8480</span> UIKitCore`+[UIView(UIViewAnimationWithBlocks) animateWithDuration:delay:options:animations:completion:] + <span class="number">108</span></span><br><span class="line">    frame #<span class="number">14</span>: <span class="number">0x000000010710a74c</span> Glip`+[UIView(instrumentation) ADEumAnimateWithDuration:delay:options:animations:completion:] + <span class="number">300</span></span><br><span class="line">    frame #<span class="number">15</span>: <span class="number">0x00000001d03c2650</span> UIKitCore`-[_UIWindowRotationAnimationController animateTransition:] + <span class="number">456</span></span><br><span class="line">    frame #<span class="number">16</span>: <span class="number">0x00000001d0968398</span> UIKitCore`-[UIWindow _rotateToBounds:withAnimator:transitionContext:] + <span class="number">580</span></span><br><span class="line">    frame #<span class="number">17</span>: <span class="number">0x00000001d096aafc</span> UIKitCore`-[UIWindow _rotateWindowToOrientation:updateStatusBar:duration:skipCallbacks:] + <span class="number">1184</span></span><br><span class="line">    frame #<span class="number">18</span>: <span class="number">0x00000001d096b1b0</span> UIKitCore`-[UIWindow _setRotatableClient:toOrientation:updateStatusBar:duration:force:isRotating:] + <span class="number">516</span></span><br><span class="line">    frame #<span class="number">19</span>: <span class="number">0x00000001d096a5b0</span> UIKitCore`-[UIWindow _setRotatableViewOrientation:updateStatusBar:duration:force:] + <span class="number">128</span></span><br><span class="line">    frame #<span class="number">20</span>: <span class="number">0x00000001d096925c</span> UIKitCore`__57-[UIWindow _updateToInterfaceOrientation:duration:force:]_block_invoke + <span class="number">124</span></span><br><span class="line">    frame #<span class="number">21</span>: <span class="number">0x00000001d0969160</span> UIKitCore`-[UIWindow _updateToInterfaceOrientation:duration:force:] + <span class="number">560</span></span><br><span class="line">    frame #<span class="number">22</span>: <span class="number">0x00000001a43595bc</span> CoreFoundation`__CFNOTIFICATIONCENTER_IS_CALLING_OUT_TO_AN_OBSERVER__ + <span class="number">20</span></span><br><span class="line">    frame #<span class="number">23</span>: <span class="number">0x00000001a4359588</span> CoreFoundation`___CFXRegistrationPost_block_invoke + <span class="number">64</span></span><br><span class="line">    frame #<span class="number">24</span>: <span class="number">0x00000001a4358a7c</span> CoreFoundation`_CFXRegistrationPost + <span class="number">392</span></span><br><span class="line">    frame #<span class="number">25</span>: <span class="number">0x00000001a4358728</span> CoreFoundation`___CFXNotificationPost_block_invoke + <span class="number">96</span></span><br><span class="line">    frame #<span class="number">26</span>: <span class="number">0x00000001a42d2524</span> CoreFoundation`-[_CFXNotificationRegistrar find:object:observer:enumerator:] + <span class="number">1496</span></span><br><span class="line">    frame #<span class="number">27</span>: <span class="number">0x00000001a43581d8</span> CoreFoundation`_CFXNotificationPost + <span class="number">696</span></span><br><span class="line">    frame #<span class="number">28</span>: <span class="number">0x00000001a4d40814</span> Foundation`-[NSNotificationCenter postNotificationName:object:userInfo:] + <span class="number">68</span></span><br><span class="line">    frame #<span class="number">29</span>: <span class="number">0x00000001d05c2030</span> UIKitCore`-[UIDevice setOrientation:animated:] + <span class="number">328</span></span><br><span class="line">    frame #<span class="number">30</span>: <span class="number">0x00000001d01f071c</span> UIKitCore`__124-[_UICanvasDeviceOrientationSettingsDiffAction _updateDeviceOrientationWithSettingObserverContext:canvas:transitionContext:]_block_invoke + <span class="number">88</span></span><br><span class="line">    frame #<span class="number">31</span>: <span class="number">0x00000001d01f2304</span> UIKitCore`_performChangesWithTransitionContext + <span class="number">836</span></span><br><span class="line">    frame #<span class="number">32</span>: <span class="number">0x00000001d01f0688</span> UIKitCore`-[_UICanvasDeviceOrientationSettingsDiffAction _updateDeviceOrientationWithSettingObserverContext:canvas:transitionContext:] + <span class="number">236</span></span><br><span class="line">    frame #<span class="number">33</span>: <span class="number">0x00000001d01f058c</span> UIKitCore`__133-[_UICanvasDeviceOrientationSettingsDiffAction performActionsForCanvas:withUpdatedScene:settingsDiff:fromSettings:transitionContext:]_block_invoke + <span class="number">104</span></span><br><span class="line">    frame #<span class="number">34</span>: <span class="number">0x00000001d01f1fb0</span> UIKitCore`_performActionsWithDelayForTransitionContext + <span class="number">112</span></span><br><span class="line">    frame #<span class="number">35</span>: <span class="number">0x00000001d01f04e0</span> UIKitCore`-[_UICanvasDeviceOrientationSettingsDiffAction performActionsForCanvas:withUpdatedScene:settingsDiff:fromSettings:transitionContext:] + <span class="number">172</span></span><br><span class="line">    frame #<span class="number">36</span>: <span class="number">0x00000001d01f5d84</span> UIKitCore`-[_UICanvas scene:didUpdateWithDiff:transitionContext:completion:] + <span class="number">360</span></span><br><span class="line">    frame #<span class="number">37</span>: <span class="number">0x00000001d05253b8</span> UIKitCore`-[UIApplicationSceneClientAgent scene:handleEvent:withCompletion:] + <span class="number">464</span></span><br><span class="line">    frame #<span class="number">38</span>: <span class="number">0x00000001a6d63920</span> FrontBoardServices`__80-[FBSSceneImpl updater:didUpdateSettings:withDiff:transitionContext:completion:]_block_invoke_3 + <span class="number">224</span></span><br><span class="line">    frame #<span class="number">39</span>: <span class="number">0x00000001356e4c74</span> libdispatch.dylib`_dispatch_client_callout + <span class="number">16</span></span><br><span class="line">    frame #<span class="number">40</span>: <span class="number">0x00000001356e8840</span> libdispatch.dylib`_dispatch_block_invoke_direct + <span class="number">232</span></span><br><span class="line">    frame #<span class="number">41</span>: <span class="number">0x00000001a6d9d0bc</span> FrontBoardServices`__FBSSERIALQUEUE_IS_CALLING_OUT_TO_A_BLOCK__ + <span class="number">40</span></span><br><span class="line">    frame #<span class="number">42</span>: <span class="number">0x00000001a6d9cd58</span> FrontBoardServices`-[FBSSerialQueue _performNext] + <span class="number">408</span></span><br><span class="line">    frame #<span class="number">43</span>: <span class="number">0x00000001a6d9d310</span> FrontBoardServices`-[FBSSerialQueue _performNextFromRunLoopSource] + <span class="number">52</span></span><br><span class="line">    frame #<span class="number">44</span>: <span class="number">0x00000001a437a2bc</span> CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + <span class="number">24</span></span><br><span class="line">    frame #<span class="number">45</span>: <span class="number">0x00000001a437a23c</span> CoreFoundation`__CFRunLoopDoSource0 + <span class="number">88</span></span><br><span class="line">    frame #<span class="number">46</span>: <span class="number">0x00000001a4379b24</span> CoreFoundation`__CFRunLoopDoSources0 + <span class="number">176</span></span><br><span class="line">    frame #<span class="number">47</span>: <span class="number">0x00000001a4374a60</span> CoreFoundation`__CFRunLoopRun + <span class="number">1004</span></span><br><span class="line">    frame #<span class="number">48</span>: <span class="number">0x00000001a4374354</span> CoreFoundation`CFRunLoopRunSpecific + <span class="number">436</span></span><br><span class="line">    frame #<span class="number">49</span>: <span class="number">0x00000001a657479c</span> GraphicsServices`GSEventRunModal + <span class="number">104</span></span><br><span class="line">    frame #<span class="number">50</span>: <span class="number">0x00000001d092bb68</span> UIKitCore`UIApplicationMain + <span class="number">212</span></span><br><span class="line">    frame #<span class="number">51</span>: <span class="number">0x000000010525d370</span> Glip`main at AppDelegate.swift:<span class="number">67</span>:<span class="number">7</span></span><br><span class="line">    frame #<span class="number">52</span>: <span class="number">0x00000001a3e3a8e0</span> libdyld.dylib`start + <span class="number">4</span></span><br></pre></td></tr></table></figure><p>最后通过断点定位，发现问题出在</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">frame #<span class="number">22</span>: <span class="number">0x00000001a43595bc</span> CoreFoundation`__CFNOTIFICATIONCENTER_IS_CALLING_OUT_TO_AN_OBSERVER__ + <span class="number">20</span></span><br><span class="line">frame #<span class="number">23</span>: <span class="number">0x00000001a4359588</span> CoreFoundation`___CFXRegistrationPost_block_invoke + <span class="number">64</span></span><br><span class="line">frame #<span class="number">24</span>: <span class="number">0x00000001a4358a7c</span> CoreFoundation`_CFXRegistrationPost + <span class="number">392</span></span><br><span class="line">frame #<span class="number">25</span>: <span class="number">0x00000001a4358728</span> CoreFoundation`___CFXNotificationPost_block_invoke + <span class="number">96</span></span><br><span class="line">frame #<span class="number">26</span>: <span class="number">0x00000001a42d2524</span> CoreFoundation`-[_CFXNotificationRegistrar find:object:observer:enumerator:] + <span class="number">1496</span></span><br><span class="line">frame #<span class="number">27</span>: <span class="number">0x00000001a43581d8</span> CoreFoundation`_CFXNotificationPost + <span class="number">696</span></span><br><span class="line">frame #<span class="number">28</span>: <span class="number">0x00000001a4d40814</span> Foundation`-[NSNotificationCenter postNotificationName:object:userInfo:] + <span class="number">68</span></span><br><span class="line">frame #<span class="number">29</span>: <span class="number">0x00000001d05c2030</span> UIKitCore`-[UIDevice setOrientation:animated:] + <span class="number">328</span></span><br></pre></td></tr></table></figure><p>不论APP是否支持旋转，<code>[UIDevice setOrientation:animated:]</code> 都会调用，且参数值也是对的。关键在于下一步，当APP支持旋转的时候，会发出一个<code>UIDeviceOrientationDidChangeNotification</code> 通知，不支持旋转的时候就不会。</p><p>于是问题就转化成了：什么情况下，系统有可能会不发出 <code>UIDeviceOrientationDidChangeNotification</code> 通知呢？</p><p>遇事不决，看文档。</p><p>在 <code>UIDevice.h</code> 中找到这三个玩意儿</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">readonly</span>,<span class="keyword">getter</span>=isGeneratingDeviceOrientationNotifications) <span class="built_in">BOOL</span> generatesDeviceOrientationNotifications __TVOS_PROHIBITED;</span><br><span class="line">- (<span class="keyword">void</span>)beginGeneratingDeviceOrientationNotifications __TVOS_PROHIBITED;      <span class="comment">// nestable</span></span><br><span class="line">- (<span class="keyword">void</span>)endGeneratingDeviceOrientationNotifications __TVOS_PROHIBITED;</span><br></pre></td></tr></table></figure><p>看着应该就是罪魁祸首了。</p><h2 id="定位问题"><a href="#定位问题" class="headerlink" title="定位问题"></a>定位问题</h2><p>调试发现，在APP支持旋转时 <code>isGeneratingDeviceOrientationNotifications = true</code>；<br>不支持时  <code>isGeneratingDeviceOrientationNotifications=false</code>。</p><p>查看 <code>generatesDeviceOrientationNotifications</code> 文档：</p><blockquote><p>If the value of this property is YES, the shared UIDevice object posts a UIDeviceOrientationDidChangeNotification notification when the device changes orientation. If the value is NO, it generates no orientation notifications. Device orientation notifications can only be generated between calls to the beginGeneratingDeviceOrientationNotifications and endGeneratingDeviceOrientationNotifications methods.</p></blockquote><p>查看 <code>beginGeneratingDeviceOrientationNotifications</code> 文档：</p><blockquote><p>You must call this method before attempting to get orientation data from the receiver. This method enables the device’s accelerometer hardware and begins the delivery of acceleration events to the receiver. The receiver subsequently uses these events to post UIDeviceOrientationDidChangeNotification notifications when the device orientation changes and to update the orientation property.<br>You may nest calls to this method safely, but you should always match each call with a corresponding call to the endGeneratingDeviceOrientationNotifications method.</p></blockquote><p>所以 <code>isGeneratingDeviceOrientationNotifications</code> 的值是受另外两个方法影响的。</p><p><strong>看来已经找到原因了</strong></p><p>继续调试发现，项目代码内部并没有调用到 <code>beginGeneratingDeviceOrientationNotifications</code> 和 <code>endGeneratingDeviceOrientationNotifications</code>。</p><h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>当 <code>-[UIWindow setRootViewController:]</code>的时候，系统会调用 <code>beginGeneratingDeviceOrientationNotifications</code>，当 <code>-[UIWindow dealloc]</code> 时，会调用 <code>endGeneratingDeviceOrientationNotifications</code>，这么看系统的这个逻辑是没什么问题的。<br>问题出在于 WebRTC 中，在 start video session 的时候有调用 <code>beginGeneratingDeviceOrientationNotifications</code>，stop video session 的时候有调用 <code>endGeneratingDeviceOrientationNotifications</code>。但是CoreLib里的代码有点问题，start video session 的时候并没有调用 <code>beginGeneratingDeviceOrientationNotifications</code> ，导致这两个没有成对出现，从而出错。</p><p>以前没有特别关注过这三者：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">readonly</span>,<span class="keyword">getter</span>=isGeneratingDeviceOrientationNotifications) <span class="built_in">BOOL</span> generatesDeviceOrientationNotifications __TVOS_PROHIBITED;</span><br><span class="line">- (<span class="keyword">void</span>)beginGeneratingDeviceOrientationNotifications __TVOS_PROHIBITED;      <span class="comment">// nestable</span></span><br><span class="line">- (<span class="keyword">void</span>)endGeneratingDeviceOrientationNotifications __TVOS_PROHIBITED;</span><br></pre></td></tr></table></figure><p>以后遇到旋转问题，又多了一条思路了..</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;现象&quot;&gt;&lt;a href=&quot;#现象&quot; class=&quot;headerlink&quot; title=&quot;现象&quot;&gt;&lt;/a&gt;现象&lt;/h2&gt;&lt;p&gt;最近发现一个很神奇的bug，加入某个会议之后然后退出，重复3次，界面就无法旋转了。&lt;/p&gt;
&lt;h2 id=&quot;猜测&quot;&gt;&lt;a href=&quot;#猜测
      
    
    </summary>
    
    
      <category term="iOS" scheme="https://shixiong.name/tags/iOS/"/>
    
      <category term="Orientation" scheme="https://shixiong.name/tags/Orientation/"/>
    
  </entry>
  
  <entry>
    <title>【译】写给自己的软件工程笔记</title>
    <link href="https://shixiong.name/2019/03/29/note-to-myself-on-software-engineering/"/>
    <id>https://shixiong.name/2019/03/29/note-to-myself-on-software-engineering/</id>
    <published>2019-03-29T08:53:45.000Z</published>
    <updated>2019-07-30T02:17:17.770Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>这是 Keras 的开发者 François Chollet 整理的笔记，里面有很多思考值得学习。<br><a href="https://medium.com/s/story/notes-to-myself-on-software-engineering-c890f16f4e4d" target="_blank" rel="noopener">原文链接</a></p></blockquote><h1 id="在开发过程中"><a href="#在开发过程中" class="headerlink" title="在开发过程中"></a>在开发过程中</h1><ol><li><p>代码不仅仅意味着要被执行的。代码也是团队之间的沟通方式，是向他人描述问题解决方案的一种方式。（写出）具有较高可读性的代码不是一件值得骄傲的事情，它是编写代码最基础的部分了。这其中包括清楚地分解代码，选择不言自明的变量名，并插入合适的注释来描述隐含的任何内容。</p></li><li><p>当你提交每个PR的时候，要思考的不是这个PR能给你的下次升职带来什么，而应该是这个PR可以为你的用户和社区做些什么。要不惜一切代价地避免“狠显眼的贡献”。如果不是很明显的能帮助产品的目的，就请不要添加任何功能。  </p></li><li><p>代码也是有品位的。品味是由对简单的渴望而产生符合约束-满足规范的过程，要时刻保持着对简单的执念。</p></li><li><p>敢于拒绝 - 只是因为有人要求提供功能并不意味着你应该这么做。每项功能的成本都超出了最初的实施范围：因为有维护成本、文档成本和用户的认知成本。如果你总是问：我们真的应该这样做吗？通常答案都会是否定的。</p></li><li><p>当你对用户提出的新的功能需求说“是”时，请记住，用户要的东西通常都不是最佳的选择。用户值专注于他们自己的特定的需求，你必须以项目的整体性和自有的原则来应对这一点。通常正确的答案会是扩展现有的功能。</p></li><li><p>在持续集成和以全面覆盖单元测试为目标这两件事上多投入。这样可以确保你能处在一个自信的编码环境中；如果不是这样，那么首要任务就应该是关注建立正确的基础设施。</p></li><li><p>没有提前计划好一些没有关系。不断地尝试然后看看结果如何。提早纠错，确保你创建了一个没有不可能的环境。</p></li><li><p>好的软件会让事情变得简单。仅仅因为一开始问题看起来很困难并不意味着解决方案必须复杂或难以使用。很多时候，在一个会有更容易的方案但可能不是那么明显的情况下，工程师往往会条件反射式地选择引入复杂度很高的解决方案（让我们使用ML！让我们构建一个应用程序！让我们添加区块链！）。在你写下任何代码前，确保你的解决方案不能再简单了。任何事情遵循第一性原理。</p></li><li><p>避免很隐晦的规则。当你发现自己开发了一种较为隐晦的规则时，应保持规则明确并与他人共享或自动化。每当你发现自己想出一个反复的，准算法的工作流程时，应该设法将其形式化为一个文档化的流程，以便其他团队成员从该体验中受益。此外，你应该设法在自动化这种任何可被自动化的工作流程部份（例如，正确性检查）。</p></li><li><p>在设计过程中应考虑你所做选择的全局影响，而不仅仅是自己想要关注的部分 - 例如收入或增长。除了你当前正在监控的指标之外，你的软件对全球用户的总体影响是什么？是否存在超出价值主张的不良副作用？在保留软件实用性的同时，你可以做些什么来解决它们？</p></li></ol><blockquote><p>道德设计，将你的价值观融入在你的创作中。</p></blockquote><h1 id="API设计"><a href="#API设计" class="headerlink" title="API设计"></a>API设计</h1><ol><li><p>你的API是有用户的，所以它应该也要有用户体验。在你做出的每一个决定中，都要牢记你的用户。对用户充满同理心，无论他们是初学者还是经验老道的老司机。</p></li><li><p>始终寻求在使用API​​的过程中尽量减少对用户的认知负担。自动化可自动化的内容，最大限度地减少用户所需的操作和选择，不要暴露不重要的选项，设计简单一致的工作流程，以反映简单一致的心理模型。</p></li><li><p>简单的事情应该是简单的，复杂的事情应该是可能的（Simple things should be simple, complex things should be possible. —-Alan Kay）。不要为了小众用例增加常见用例的认知负荷，即使影响很小。</p></li><li><p>如果工作流的认知负荷足够低，那么用户应该可以在完成一次或两次之后就可以记住它（无需查阅教程或文档）。</p></li><li><p>寻求拥有与领域专家和从业者的心理模型相匹配的API。拥有领域经验但对你的API没有经验的人应该能够看最少的文档就能直观地明白你的API，很多时候只需要通过查看几个代码示例并查看哪些对象可用以及它们的签名是什么。</p></li><li><p>在没有任何关于底层实现的上下文情况下，参数的含义应该是可理解的。必须由用户指定的参数应该与用户对问题的心理模型有关，而不是跟代码的实现细节有关。API代表的是它解决了什么问题，而不是它背后是如何运行的。</p></li><li><p>最强大的心理模型是模块化和分层的：高度简单，但是当你需要了解细节时，又很精细。同样，一个好的API是模块化和分层的：易于使用，但又具有表现力。对象少，但签名复杂，与对象多但签名简单之间存在着一个平衡。一个好的API应该有合理数量的对象，且具有相当简单的签名。</p></li><li><p>你的API不可避免地反映了你选择的实现，特别是你选择的数据结构。要实现直观的API，你必须一开始就选择自然适合的数据结构 - 与该领域专家的心智模型相匹配。</p></li><li><p>故意设计端到端工作流程，而不是一组原子功能。大多数开发人员会询问：”应该提供哪些功能来处理API设计？让我们为他们配置选项吧。“相反地，应该问：该工具的用例是什么？对于每个用例，用户操作的最佳顺序是什么？什么是可以支持这个工作流程最简单的API？ API中的原子选项应该能够满足高级工作流程中出现的明确需求 - 不应该“因为有人可能需要它”就添加它们。</p></li><li><p>错误消息以及通常在与API交互过程中向用户提供的任何反馈都是API的一部分。交互性和反馈是用户体验不可或缺的一部分。要为你的API设计错误消息。</p></li><li><p>因为代码是一种交流，所以命名很重要 - 无论是项目还是变量的命名。名称反映了你对问题的看法。避免使用过于通用的名称（x，变量，参数），避免 <code>OverlyLongAndSpecificNamingPatterns</code>，避免可能产生不必要的术语（主，从），并确保在命名选择中保持一致。命名一致性意味着内部命名一致性（不要一些地方用”dim“代表坐标轴，在另一些地方用”axis“）以及与问题域的既定约定的一致性。在命名之前，应尽量使用该领域专家（或其他API）已在使用的命名。</p></li><li><p>文档是API用户体验的核心，它不是附属品。在高质量的文档上多花时间，你会得到比在更多功能上多花时间更高的回报。</p></li><li><p>展示，而不是解释：你的文档不应该讨论软件的工作原理，它应该说明如何使用它。展示端到端工作流的代码示例、显示API的每个常见用例和关键功能的代码示例。</p></li></ol><blockquote><p>生产力归结为快速决策和执行力。</p></blockquote><h1 id="软件生涯"><a href="#软件生涯" class="headerlink" title="软件生涯"></a>软件生涯</h1><ol><li><p>职业发展并不是你管理人数的多少，而是你所产生的影响，这个世界有你没你会有多大的差别?</p></li><li><p>软件开发是一项团队合作；它与人际关系和技术能力有关。做个好伙伴，当你不断前行时，不要忘了与人保持联系。</p></li><li><p><strong>技术永远不会是中立的</strong>。如果你的工作对世界有任何影响，那么这种影响就有道德方向。我们在软件产品中看似无害的技术选择都会被充满使用动机，谁将受益，谁将受到影响。技术选择也是道德选择。因此，始终谨慎而明确地表达你想要支持的价值观。道德设计，将您的价值观融入您的创作中。永远不要想，我只是在建立这种能力，这本身是中立的。你构建它的方式无法决定它被使用的方式。</p></li><li><p>自我引导，你的工作和环境的力量，是生活满意度的关键。确保你给予周围的人充分的自我引导，并确保你的职业选择能够为你自己带来更多的力量。</p></li><li><p>去创造这个世界需要的东西，而不仅仅是你希望拥有的东西。技术人员常常会边过着稀薄的生活，边专注于满足自身特定需求的产品。寻找机会拓宽你的生活体验，让自己能更好地发现这个世界需要什么。</p></li><li><p>在做出会有长期影响的任何选择时，请将你的价值观置于短期的自身利益和过度的情绪之上 - 例如贪婪或恐惧。认清你的价值观，并让它们引导你。</p></li><li><p>当我们发现自己陷入冲突时，先暂停下来并承认我们的共同价值观和共同目标是个不错的主意，提醒彼此，我们是在同一条船上的。</p></li><li><p>生产力归结为高速决策和执行力。这需要a）良好的直觉，这来自以往的经验，它可以帮你在只给出部分信息的情况下就做出普遍正确的决定; b）敏锐地意识到何时应该更谨慎的行动并等待更多信息，因为错误决策会比延期付出更高的代价。最快的速度/最好的质量之间的决策往往会在不同环境而有不同的权衡。</p></li><li><p>更快地做出决策意味着你在职业生涯中要做出更多决策，这将使你对正确的选项有更强的直觉。经验是提高生产力的关键，更高的生产力将为你提供更多的经验：良性循环。</p></li><li><p>在你意识到缺乏直觉的情况下，请遵守抽象原则。在整个职业生涯中建立尝试过且正确的原则列表。原则是形式化的直觉，相比于原始直觉（需要对类似情况的有直接且丰富的经验），它能适用于更广泛的场景。</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;这是 Keras 的开发者 François Chollet 整理的笔记，里面有很多思考值得学习。&lt;br&gt;&lt;a href=&quot;https://medium.com/s/story/notes-to-myself-on-software-enginee
      
    
    </summary>
    
    
      <category term="心得" scheme="https://shixiong.name/tags/%E5%BF%83%E5%BE%97/"/>
    
      <category term="软件工程" scheme="https://shixiong.name/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>ARTS挑战-第二周</title>
    <link href="https://shixiong.name/2019/03/29/arts-second-week/"/>
    <id>https://shixiong.name/2019/03/29/arts-second-week/</id>
    <published>2019-03-29T08:16:23.000Z</published>
    <updated>2019-07-30T02:17:17.743Z</updated>
    
    <content type="html"><![CDATA[<h1 id="什么是ARTS？"><a href="#什么是ARTS？" class="headerlink" title="什么是ARTS？"></a>什么是ARTS？</h1><blockquote><p>1.Algorithm：每周至少做一个 leetcode 的算法题<br>2.Review：阅读并点评至少一篇英文技术文章<br>3.Tip：学习至少一个技术技巧<br>4.Share：分享一篇有观点和思考的技术文章</p></blockquote><h1 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h1><blockquote><p>一开始以为这道题目挺难的，后来其实慢慢的研究下去发现还好，就是2数相加，需要考虑进位的问题。代码提交后看了一下Solution，发现思路大致也差不多。一开始还怀疑自己，没想到能抓到老鼠的都是好猫。</p></blockquote><p><strong>Q:</strong></p><p>You are given two non-empty linked lists representing two non-negative integers. The digits are stored in reverse order and each of their nodes contain a single digit. Add the two numbers and return it as a linked list.</p><p>You may assume the two numbers do not contain any leading zero, except the number 0 itself.</p><p>Example:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: (2 -&gt; 4 -&gt; 3) + (5 -&gt; 6 -&gt; 4)</span><br><span class="line">Output: 7 -&gt; 0 -&gt; 8</span><br><span class="line">Explanation: 342 + 465 = 807.</span><br></pre></td></tr></table></figure><p><strong>A:</strong></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for singly-linked list.</span></span><br><span class="line"><span class="comment"> * public class ListNode &#123;</span></span><br><span class="line"><span class="comment"> *     public var val: Int</span></span><br><span class="line"><span class="comment"> *     public var next: ListNode?</span></span><br><span class="line"><span class="comment"> *     public init(_ val: Int) &#123;</span></span><br><span class="line"><span class="comment"> *         self.val = val</span></span><br><span class="line"><span class="comment"> *         self.next = nil</span></span><br><span class="line"><span class="comment"> *     &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// 两个数字相加，并返回十位和个位</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">addNum</span><span class="params">(<span class="number">_</span> num1: Int, <span class="number">_</span> num2: Int)</span></span> -&gt; (high: <span class="type">Int</span>, low: <span class="type">Int</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> resultH = <span class="number">0</span></span><br><span class="line">        <span class="keyword">var</span> resultL = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> sum = num1 + num2</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> sum &gt;= <span class="number">10</span> &#123;</span><br><span class="line">            resultH = <span class="number">1</span></span><br><span class="line">            resultL = sum - <span class="number">10</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resultL = sum</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (resultH, resultL)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">addTwoNumbers</span><span class="params">(<span class="number">_</span> l1: ListNode?, <span class="number">_</span> l2: ListNode?)</span></span> -&gt; <span class="type">ListNode</span>? &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> l1 = l1, <span class="keyword">let</span> l2 = l2 &#123;</span><br><span class="line">            <span class="keyword">var</span> node1: <span class="type">ListNode</span>? = l1</span><br><span class="line">            <span class="keyword">var</span> node2: <span class="type">ListNode</span>? = l2</span><br><span class="line">            <span class="keyword">var</span> cursor: <span class="type">ListNode</span>?</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">var</span> waitToAdd: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">            <span class="keyword">var</span> result: <span class="type">ListNode</span>? = <span class="type">ListNode</span>(-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> <span class="literal">true</span> &#123;</span><br><span class="line">                <span class="comment">// 当两个node节点均为空了停止循环</span></span><br><span class="line">                <span class="keyword">if</span> node1 == <span class="literal">nil</span>, node2 == <span class="literal">nil</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 构建空节点</span></span><br><span class="line">                <span class="keyword">if</span> node1 == <span class="literal">nil</span> &#123;</span><br><span class="line">                    node1 = <span class="type">ListNode</span>(<span class="number">0</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> node2 == <span class="literal">nil</span> &#123;</span><br><span class="line">                    node2 = <span class="type">ListNode</span>(<span class="number">0</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">let</span> r = addNum(node1!.val, node2!.val)</span><br><span class="line">                <span class="keyword">let</span> t = addNum(r.low, waitToAdd)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> t.high == <span class="number">1</span> &#123;</span><br><span class="line">                    waitToAdd = t.high</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    waitToAdd = r.high</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> result?.val == -<span class="number">1</span> &#123;</span><br><span class="line">                    result?.val = t.low</span><br><span class="line">                    cursor = result</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> node = <span class="type">ListNode</span>(t.low)</span><br><span class="line">                    cursor?.next = node</span><br><span class="line">                    cursor = node</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                node1 = node1!.next</span><br><span class="line">                node2 = node2!.next</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> waitToAdd != <span class="number">0</span> &#123;</span><br><span class="line">                cursor?.next = <span class="type">ListNode</span>(<span class="number">1</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> l1 == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> l2</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> l2 == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> l1</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h1><p>这一篇 <a href="https://www.bignerdranch.com/blog/pro-pattern-matching-in-swift/" target="_blank" rel="noopener">Pro Pattern-Matching in Swift</a> 把 Swift 中的 Pattern[ˈpatərn]-Matching 讲得比较详细了。 Pattern-Matching 是 Swift 中一个能把代码写得整洁又安全的方式，必须掌握。</p><h1 id="Tip"><a href="#Tip" class="headerlink" title="Tip"></a>Tip</h1><p>Swift 中部分高阶函数对比（以操作数组为例）：<br><code>map</code> vs <code>flatMap</code> vs <code>compactMap</code> vs <code>filter</code> vs <code>reduce</code></p><h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><p>将数组中的每个元素进行一次操作</p><h3 id="flatMap"><a href="#flatMap" class="headerlink" title="flatMap"></a>flatMap</h3><p>同map，但是不会返回nil，且会对数组中的 <code>optional</code> 进行解包</p><h3 id="compactMap"><a href="#compactMap" class="headerlink" title="compactMap"></a>compactMap</h3><p>如果 <code>flatMap</code> 的回调中可能返回 <code>optional</code>，则需要使用 <code>compactMap</code></p><blockquote><p>‘flatMap’ is deprecated: Please use compactMap(_:) for the case where closure returns an optional value</p></blockquote><h3 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h3><p>顾名思义，可以按照 <code>closure</code> 中的标准，把数组中的一些元素过滤掉</p><h3 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h3><p><code>reduce</code> 就是可以把数组拍平，比如一个 <code>[String]</code>，用 <code>reduce</code> 可以让它返回成 <code>String</code></p><h1 id="Share"><a href="#Share" class="headerlink" title="Share"></a>Share</h1><p><a href="https://shixiong.name/2019/03/29/note-to-myself-on-software-engineering/">Notes to Myself on Software Engineering</a>，这是 Keras 的开发者 François Chollet 整理的笔记，里面有很多思考值得学习。由于写得太好了，我把它翻译了一下。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;什么是ARTS？&quot;&gt;&lt;a href=&quot;#什么是ARTS？&quot; class=&quot;headerlink&quot; title=&quot;什么是ARTS？&quot;&gt;&lt;/a&gt;什么是ARTS？&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;1.Algorithm：每周至少做一个 leetcode 的算法题
      
    
    </summary>
    
    
      <category term="ARTS" scheme="https://shixiong.name/tags/ARTS/"/>
    
  </entry>
  
  <entry>
    <title>ARTS挑战-第一周</title>
    <link href="https://shixiong.name/2019/03/25/arts-first-week/"/>
    <id>https://shixiong.name/2019/03/25/arts-first-week/</id>
    <published>2019-03-25T08:25:19.000Z</published>
    <updated>2019-07-30T02:17:17.743Z</updated>
    
    <content type="html"><![CDATA[<h1 id="什么是ARTS？"><a href="#什么是ARTS？" class="headerlink" title="什么是ARTS？"></a>什么是ARTS？</h1><blockquote><p>1.Algorithm：每周至少做一个 leetcode 的算法题<br>2.Review：阅读并点评至少一篇英文技术文章<br>3.Tip：学习至少一个技术技巧<br>4.Share：分享一篇有观点和思考的技术文章</p></blockquote><h1 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h1><p><strong>Q:</strong></p><p>Given an array of integers, return indices of the two numbers such that they add up to a specific target.</p><p>You may assume that each input would have exactly one solution, and you may not use the same element twice.</p><p>Example:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Given nums = [2, 7, 11, 15], target = 9,</span><br><span class="line"></span><br><span class="line">Because nums[0] + nums[1] = 2 + 7 = 9,</span><br><span class="line">return [0, 1].</span><br></pre></td></tr></table></figure><p><strong>A:</strong></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">twoSum</span><span class="params">(<span class="number">_</span> nums: [Int], <span class="number">_</span> target: Int)</span></span> -&gt; [<span class="type">Int</span>] &#123;</span><br><span class="line">        <span class="keyword">for</span> (i, firstItem) <span class="keyword">in</span> nums.enumerated() &#123;</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> i+<span class="number">1</span>..&lt;nums.<span class="built_in">count</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> secondItem = nums[j]</span><br><span class="line">                <span class="keyword">let</span> sum = firstItem + secondItem</span><br><span class="line">                <span class="keyword">if</span> sum == target &#123;</span><br><span class="line">                    <span class="keyword">return</span> [i, j]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h1><p>这周分享的一篇技术文章是<a href="https://medium.com/genesis-media/designing-a-workflow-with-functions-that-are-capable-of-failing-c1fb796aa084" target="_blank" rel="noopener">Designing a workflow with functions that are capable of failing</a>，主要介绍了更好的错误处理工作流，包括Swift里标准库新加入的Result<t>，以及适配重试网络请求等逻辑。<br>（这两天找个时间翻译一下）</t></p><h1 id="Tip"><a href="#Tip" class="headerlink" title="Tip"></a>Tip</h1><p>这周在写Swift的时候，由于我在一个变量的didSet中加入了一些处理的方式，在某些情况下，需要触发变量的didSet方法，于是就会有这样的代码：<code>self.model = self.model</code>，这个时候Xcode会报警：<code>assign a property to itself</code>。所以在Swift里，是不能把自己赋给自己的。</p><p>怎么解决呢？</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> temp = <span class="keyword">self</span>.model</span><br><span class="line"><span class="keyword">self</span>.model = temp</span><br></pre></td></tr></table></figure><p>这样子就简单解决了。可是这样子其他想 assign a property to itself 的地方就得也这么写一遍，有点繁琐。于是就在思考有没有更好的办法呢？</p><p><strong>可以通过自定义operator</strong></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">prefix</span> <span class="keyword">operator</span> &lt;&lt;</span><br><span class="line"><span class="keyword">prefix</span> <span class="function"><span class="keyword">func</span> &lt;&lt; &lt;T: Any&gt;<span class="params">(t: T)</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> temp = t</span><br><span class="line">    <span class="keyword">return</span> temp</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样在想要把自己赋给自己的地方这么写就行了</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.model &lt;&lt;= <span class="keyword">self</span>.model</span><br></pre></td></tr></table></figure><h1 id="Share"><a href="#Share" class="headerlink" title="Share"></a>Share</h1><p>这周重温了一下objc的 <a href="https://objccn.io/issue-15-1/" target="_blank" rel="noopener">行为驱动开发</a></p><blockquote><p>有时候改变自己的思维方式真不是一件容易的事，但是当真的能接受新的思考方式并转变的话，一定会有更大的突破的。</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;什么是ARTS？&quot;&gt;&lt;a href=&quot;#什么是ARTS？&quot; class=&quot;headerlink&quot; title=&quot;什么是ARTS？&quot;&gt;&lt;/a&gt;什么是ARTS？&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;1.Algorithm：每周至少做一个 leetcode 的算法题
      
    
    </summary>
    
    
      <category term="ARTS" scheme="https://shixiong.name/tags/ARTS/"/>
    
  </entry>
  
  <entry>
    <title>探究使用Method Swizzling的正确姿势</title>
    <link href="https://shixiong.name/2019/03/01/the-right-way-to-swizzling/"/>
    <id>https://shixiong.name/2019/03/01/the-right-way-to-swizzling/</id>
    <published>2019-03-01T03:07:43.000Z</published>
    <updated>2019-07-30T02:17:17.770Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>初次接触到OC runtime机制的时候，应该都会被其黑魔法所折服。特别是在使用了Method Swizzling来hook某一个方法，改变一个已经存在的 selector 的实现的时候，实现AOP统计打点、APM检测、… 都成为了可能。</p><h2 id="危害"><a href="#危害" class="headerlink" title="危害"></a>危害</h2><p>然而，<strong>越是强大的力量，背后往往会隐藏着更大的危险。</strong></p><p>在Stackoverflow上，有一篇文章：<a href="https://stackoverflow.com/questions/5339276/what-are-the-dangers-of-method-swizzling-in-objective-c?answertab=active#tab-top" target="_blank" rel="noopener">《What are the Dangers of Method Swizzling in Objective C?》</a>，里面已经把OC中方法交换的危险描述得非常清楚了，这里做个简要的概述。</p><h3 id="1-Method-swizzling并非是原子操作"><a href="#1-Method-swizzling并非是原子操作" class="headerlink" title="1. Method swizzling并非是原子操作"></a>1. Method swizzling并非是原子操作</h3><p>其实95%的场景下，使用 Method Swizzling 都是安全的。因为我们一般希望在整个APP的生命周期里方法的替换是有效的，所以我们会在 <code>+(void)load</code> 方法里执行一系列的操作， 这个情况下是不会遇到并发问题的。但是如果不小心将代码写到了 <code>+(void)initialize</code> 中，就会有可能出现非常诡异的情况。</p><blockquote><p>其实也应该尽可能少的在 <code>+(void)initialize</code> 中做操作，否则会影响启动速度。</p></blockquote><h3 id="2-会更改到并非是我们自身代码的实现"><a href="#2-会更改到并非是我们自身代码的实现" class="headerlink" title="2. 会更改到并非是我们自身代码的实现"></a>2. 会更改到并非是我们自身代码的实现</h3><p>其实这个也是想一下就能明白的问题。如果你在没搞清楚状况的情况下去进行方法替换，可能会影响到其他人的代码。特别是，如果重写了一个类的方法时，却没有调用父类的方法，可能就会出现问题。因此为了避免可能出现的未知情况，我们最好还是要在替换方法实现里调用一下原始实现。</p><h3 id="3-可能会存在命名冲突"><a href="#3-可能会存在命名冲突" class="headerlink" title="3. 可能会存在命名冲突"></a>3. 可能会存在命名冲突</h3><p>在 Method Swizzling 的时候，我们一般会在新的方法前加上一个前缀。</p><p>如:</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)my_setFrame:(<span class="built_in">NSRect</span>)frame &#123;  </span><br><span class="line">    <span class="comment">// do custom work  </span></span><br><span class="line">    [<span class="keyword">self</span> my_setFrame:frame];  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是这样有一个问题，就是万一有某一个地方，也定义了 <code>- (void)my_setFrame:(NSRect)frame</code> 这个名字的方法，就可能出现问题。</p><p>因此最好的解决方式还是在于使用函数指针来解决这个问题（不过这样代码看起来就不那么OC了）。</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSView</span> (<span class="title">MyViewAdditions</span>)  </span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> MySetFrame(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd, <span class="built_in">NSRect</span> frame);  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> (*SetFrameIMP)(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd, <span class="built_in">NSRect</span> frame);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> MySetFrame(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd, <span class="built_in">NSRect</span> frame) &#123;  </span><br><span class="line">    <span class="comment">// do custom work  </span></span><br><span class="line">    SetFrameIMP(<span class="keyword">self</span>, _cmd, frame);  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;  </span><br><span class="line">    [<span class="keyword">self</span> swizzle:<span class="keyword">@selector</span>(setFrame:) with:(IMP)MySetFrame store:(IMP *)&amp;SetFrameIMP];  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>作者也给出了一个比较完美的swizzle方法的定义：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> IMP *IMPPointer;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="built_in">BOOL</span> class_swizzleMethodAndStore(Class <span class="keyword">class</span>, SEL original, IMP replacement, IMPPointer store) &#123;  </span><br><span class="line">    IMP imp = <span class="literal">NULL</span>;  </span><br><span class="line">    Method method = class_getInstanceMethod(<span class="keyword">class</span>, original);  </span><br><span class="line">    <span class="keyword">if</span> (method) &#123;  </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *type = method_getTypeEncoding(method);  </span><br><span class="line">        imp = class_replaceMethod(<span class="keyword">class</span>, original, replacement, type);  </span><br><span class="line">        <span class="keyword">if</span> (!imp) &#123;  </span><br><span class="line">            imp = method_getImplementation(method);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> (imp &amp;&amp; store) &#123; *store = imp; &#125;  </span><br><span class="line">    <span class="keyword">return</span> (imp != <span class="literal">NULL</span>);  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">FRRuntimeAdditions</span>)  </span></span><br><span class="line">+ (<span class="built_in">BOOL</span>)swizzle:(SEL)original with:(IMP)replacement store:(IMPPointer)store &#123;  </span><br><span class="line">    <span class="keyword">return</span> class_swizzleMethodAndStore(<span class="keyword">self</span>, original, replacement, store);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h3 id="4-会改变方法的参数"><a href="#4-会改变方法的参数" class="headerlink" title="4. 会改变方法的参数"></a>4. 会改变方法的参数</h3><p>作者认为这是一个最大的问题。当你替换了一个方法之后，其实你也替换了传入原始方法实现的参数。</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span> my_setFrame:frame];</span><br></pre></td></tr></table></figure><p>这一行做的事情是：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objc_msgSend(<span class="keyword">self</span>, <span class="keyword">@selector</span>(my_setFrame:), frame);</span><br></pre></td></tr></table></figure><p>runtime会去寻找 <code>my_setFrame:</code> 的实现，一旦找到了，就会把 <code>my_setFrame</code> 和 <code>frame</code> 传入，但其实这个时候找到的方法应该是原始的 <code>setFrame:</code>，于是当它被调用的时候，<code>_cmd</code> 这个参数并不是预期 <code>setFrame:</code>，而是 <code>my_setFrame</code>，这样就接收了一个意料之外的参数。</p><p>最好的方式还是使用如上的定义。</p><h3 id="5-方法交换带来的顺序问题"><a href="#5-方法交换带来的顺序问题" class="headerlink" title="5. 方法交换带来的顺序问题"></a>5. 方法交换带来的顺序问题</h3><p>当对多个类进行方法交换的时候，要注意顺序，特别是有父子类关系的时候。<br>比如：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">NSButton</span> swizzle:<span class="keyword">@selector</span>(setFrame:) with:<span class="keyword">@selector</span>(my_buttonSetFrame:)];</span><br><span class="line">[<span class="built_in">NSControl</span> swizzle:<span class="keyword">@selector</span>(setFrame:) with:<span class="keyword">@selector</span>(my_controlSetFrame:)];</span><br><span class="line">[<span class="built_in">NSView</span> swizzle:<span class="keyword">@selector</span>(setFrame:) with:<span class="keyword">@selector</span>(my_viewSetFrame:)];</span><br></pre></td></tr></table></figure><p>上述的实现，其实最终当你调用 <code>NSButton</code> 的 <code>setFrame</code> 的时候，会调用你替换的 <code>my_buttonSetFrame</code> 方法和 <code>NSView</code> 的原始的 <code>setFrame</code> 的方法。</p><p>相反的，如果顺序是这样的话：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">NSView</span> swizzle:<span class="keyword">@selector</span>(setFrame:) with:<span class="keyword">@selector</span>(my_viewSetFrame:)];</span><br><span class="line">[<span class="built_in">NSControl</span> swizzle:<span class="keyword">@selector</span>(setFrame:) with:<span class="keyword">@selector</span>(my_controlSetFrame:)];</span><br><span class="line">[<span class="built_in">NSButton</span> swizzle:<span class="keyword">@selector</span>(setFrame:) with:<span class="keyword">@selector</span>(my_buttonSetFrame:)];</span><br></pre></td></tr></table></figure><p>就会分别调用 <code>NSButton</code> 、 <code>NSControl</code> 和 <code>NSView</code> 的交换后的方法，这个顺序应该来说才是正确的。</p><p>所以其实这边还是建议在 <code>+(void)load</code> 方法里做方法交换，它可以保证父类的load方法在子类的方法调用前先调用，不会出错。</p><h3 id="6-会带来很多理解和调试上的不便"><a href="#6-会带来很多理解和调试上的不便" class="headerlink" title="6. 会带来很多理解和调试上的不便"></a>6. 会带来很多理解和调试上的不便</h3><p>这个就不用多说了，特别是没有文档的时候。有时候要是遇到同事写在某一个角落里的runtime操作但是没人知道的话，搞出了一些无法预见的问题，调试起来就很是蛋疼。</p><h2 id="正确姿势"><a href="#正确姿势" class="headerlink" title="正确姿势"></a>正确姿势</h2><p>所以正确的 Method Swizzling 的姿势是什么呢？</p><h3 id="①"><a href="#①" class="headerlink" title="①"></a>①</h3><p> 如上面的作者一直强调的，<strong>在load里进行方法替换</strong></p><h3 id="②"><a href="#②" class="headerlink" title="②"></a>②</h3><p>其实上面作者给出的 <code>swizzle完美定义</code> 已经是比较正确的姿势了。但是这里也记录下另一个问题。</p><p>网上一部分的文章，都会讲到，通过 Category 实现 Method Swizzling 的例子如下：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIViewController</span> (<span class="title">Tracking</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        Class <span class="keyword">class</span> = [<span class="keyword">self</span> <span class="keyword">class</span>];</span><br><span class="line"></span><br><span class="line">        SEL originalSelector = <span class="keyword">@selector</span>(viewWillAppear:);</span><br><span class="line">        SEL swizzledSelector = <span class="keyword">@selector</span>(xxx_viewWillAppear:);</span><br><span class="line"></span><br><span class="line">        Method originalMethod = class_getInstanceMethod(<span class="keyword">class</span>, originalSelector);</span><br><span class="line">        Method swizzledMethod = class_getInstanceMethod(<span class="keyword">class</span>, swizzledSelector);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// When swizzling a class method, use the following:</span></span><br><span class="line">        <span class="comment">// Class class = object_getClass((id)self);</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// Method originalMethod = class_getClassMethod(class, originalSelector);</span></span><br><span class="line">        <span class="comment">// Method swizzledMethod = class_getClassMethod(class, swizzledSelector);</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">BOOL</span> didAddMethod =</span><br><span class="line">            class_addMethod(<span class="keyword">class</span>,</span><br><span class="line">                originalSelector,</span><br><span class="line">                method_getImplementation(swizzledMethod),</span><br><span class="line">                method_getTypeEncoding(swizzledMethod));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (didAddMethod) &#123;</span><br><span class="line">            class_replaceMethod(<span class="keyword">class</span>,</span><br><span class="line">                swizzledSelector,</span><br><span class="line">                method_getImplementation(originalMethod),</span><br><span class="line">                method_getTypeEncoding(originalMethod));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            method_exchangeImplementations(originalMethod, swizzledMethod);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Method Swizzling</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)xxx_viewWillAppear:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    [<span class="keyword">self</span> xxx_viewWillAppear:animated];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"viewWillAppear: %@"</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>然而这里有一点不够严谨，也是之前有提到的危险性所在，origin_imp 如果使用了 _cmd 参数，hook之后的_cmd 是不符合预期的。</p><p>假设我们现在要hook <code>- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event;</code> </p><p>那么如果如上那么实现的话，在 <code>[self xxx_touchesBegan:touches withEvent:event];</code> 就会崩溃。原因是这个函数里有 <code>forwardTouchMethod</code>, 反汇编后实现类似：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> forwardTouchMethod(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd, <span class="built_in">NSSet</span> *touches, <span class="built_in">UIEvent</span> *event) &#123;</span><br><span class="line">  <span class="comment">// The responder chain is used to figure out where to send the next touch</span></span><br><span class="line">    <span class="built_in">UIResponder</span> *nextResponder = [<span class="keyword">self</span> nextResponder];</span><br><span class="line">    <span class="keyword">if</span> (nextResponder &amp;&amp; nextResponder != <span class="keyword">self</span>) &#123;</span><br><span class="line">      <span class="comment">// Not all touches are forwarded - so we filter here.</span></span><br><span class="line">        <span class="built_in">NSMutableSet</span> *filteredTouches = [<span class="built_in">NSMutableSet</span> set];</span><br><span class="line">        [touches enumerateObjectsUsingBlock:^(<span class="built_in">UITouch</span> *touch, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">          <span class="comment">// Checks every touch for forwarding requirements.</span></span><br><span class="line">            <span class="keyword">if</span> ([touch _wantsForwardingFromResponder:<span class="keyword">self</span> toNextResponder:nextResponder withEvent:event]) &#123;</span><br><span class="line">                [filteredTouches addObject:touch];</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// This is interesting legacy behavior. Before iOS 5, all touches are forwarded (and this is logged)</span></span><br><span class="line">                <span class="keyword">if</span> (!_UIApplicationLinkedOnOrAfter(<span class="number">12</span>)) &#123;</span><br><span class="line">                    [filteredTouches addObject:touch];</span><br><span class="line">                    <span class="comment">// Log old behavior</span></span><br><span class="line">                    <span class="keyword">static</span> <span class="built_in">BOOL</span> didLog = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">if</span> (!didLog) &#123;</span><br><span class="line">                        <span class="built_in">NSLog</span>(<span class="string">@"Pre-iOS 5.0 touch delivery method forwarding relied upon. Forwarding -%@ to %@."</span>, <span class="built_in">NSStringFromSelector</span>(_cmd), nextResponder);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">        <span class="comment">// here we basically call [nextResponder touchesBegan:filteredTouches event:event];</span></span><br><span class="line">        [nextResponder performSelector:_cmd withObject:filteredTouches withObject:event];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果我们exchange了 IMP, <code>[nextResponder performSelector:_cmd withObject:filteredTouches withObject:event];</code> 是没有相应的实现的，_cmd 就变成了 我们替换的 SEL。 显然，nextResponder没有实现相应的方法，就会crash。</p><p>那么这里可以这么写：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> IMP __original_TouchesBegan_Method_Imp;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIView</span> (<span class="title">Debug</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        Class <span class="keyword">class</span> = [<span class="keyword">self</span> <span class="keyword">class</span>];</span><br><span class="line">        </span><br><span class="line">        SEL originalSelector = <span class="keyword">@selector</span>(touchesBegan:withEvent:);</span><br><span class="line">        SEL swizzledSelector = <span class="keyword">@selector</span>(dae_touchesBegan:withEvent:);</span><br><span class="line">        </span><br><span class="line">        Method originalMethod = class_getInstanceMethod(<span class="keyword">class</span>, originalSelector);</span><br><span class="line">        Method swizzledMethod = class_getInstanceMethod(<span class="keyword">class</span>, swizzledSelector);</span><br><span class="line">        </span><br><span class="line">        __original_TouchesBegan_Method_Imp = method_getImplementation(originalMethod);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">BOOL</span> didAddMethod =</span><br><span class="line">        class_addMethod(<span class="keyword">class</span>,</span><br><span class="line">                        originalSelector,</span><br><span class="line">                        method_getImplementation(swizzledMethod),</span><br><span class="line">                        method_getTypeEncoding(swizzledMethod));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (didAddMethod) &#123;</span><br><span class="line">            class_replaceMethod(<span class="keyword">class</span>,</span><br><span class="line">                                swizzledSelector,</span><br><span class="line">                                method_getImplementation(originalMethod),</span><br><span class="line">                                method_getTypeEncoding(originalMethod));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            method_exchangeImplementations(originalMethod, swizzledMethod);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dae_touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="comment">// custom </span></span><br><span class="line">    </span><br><span class="line">     <span class="keyword">void</span> (*functionPointer)(<span class="keyword">id</span>, SEL, <span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *, <span class="built_in">UIEvent</span> *) = (<span class="keyword">void</span>(*)(<span class="keyword">id</span>, SEL, <span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *, <span class="built_in">UIEvent</span>*))__original_TouchesBegan_Method_Imp;</span><br><span class="line">        </span><br><span class="line">    functionPointer(<span class="keyword">self</span>, _cmd, touches, event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样就能找到正确的IMP了。</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://junyixie.github.io/2017/12/04/safeSwizzleRSSwizzleAnalyze/#%E9%87%87%E7%94%A8Block%E6%B7%BB%E5%8A%A0%E5%AE%9E%E7%8E%B0%EF%BC%8C%E6%B2%A1%E6%9C%89%E5%91%BD%E5%90%8D%E5%86%B2%E7%AA%81%E9%97%AE%E9%A2%98" target="_blank" rel="noopener">Method Swizzling 的正确途径</a><br><a href="https://blog.newrelic.com/engineering/right-way-to-swizzle/" target="_blank" rel="noopener">The Right Way to Swizzle in Objective-C</a><br><a href="https://stackoverflow.com/questions/5339276/what-are-the-dangers-of-method-swizzling-in-objective-c?answertab=active#tab-top" target="_blank" rel="noopener">What are the Dangers of Method Swizzling in Objective C?</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;初次接触到OC runtime机制的时候，应该都会被其黑魔法所折服。特别是在使用了Method Swizzling来hook某一个方法，改变
      
    
    </summary>
    
    
      <category term="iOS" scheme="https://shixiong.name/tags/iOS/"/>
    
      <category term="Runtime" scheme="https://shixiong.name/tags/Runtime/"/>
    
      <category term="Objective-C" scheme="https://shixiong.name/tags/Objective-C/"/>
    
      <category term="Method Swizzling" scheme="https://shixiong.name/tags/Method-Swizzling/"/>
    
  </entry>
  
  <entry>
    <title>由于Python版本太低遇到的环境问题备忘</title>
    <link href="https://shixiong.name/2019/02/25/python-backend-memo/"/>
    <id>https://shixiong.name/2019/02/25/python-backend-memo/</id>
    <published>2019-02-25T07:57:53.000Z</published>
    <updated>2019-07-30T02:17:17.770Z</updated>
    
    <content type="html"><![CDATA[<p>这两天在倒腾用Python写个接口，遇到一些问题，特此做下记录备忘，方便后面查阅。</p><h2 id="Error-A-true-SSLContext-object-is-not-available"><a href="#Error-A-true-SSLContext-object-is-not-available" class="headerlink" title="Error - A true SSLContext object is not available"></a>Error - A true SSLContext object is not available</h2><blockquote><p>InsecurePlatformWarning: A true SSLContext object is not available. This prevents urllib3 from configuring SSL<br>appropriately and may cause certain SSL connections to fail. For more information, see <a href="https://urllib3.readthedocs.org/en/latest/security.html#insecureplatformwarning" target="_blank" rel="noopener">https://urllib3.readthedocs.org/en/latest/security.html#insecureplatformwarning</a>.</p></blockquote><p>这是因为我服务器上的Python版本太低了，如果Python版本低于2.7.9之前的话，就会有这个错误提示，因为2.7.9之前的Python提供的SSL环境不是很安全。</p><p>所以理所当然我们就要升级Python的版本了。</p><h2 id="Install-Python3-7"><a href="#Install-Python3-7" class="headerlink" title="Install Python3.7"></a>Install Python3.7</h2><p><code>cat /etc/redhat-release</code></p><p>看了一眼系统是 <code>CentOS 6</code></p><p>于是先使用yum安装环境依赖。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wget 用于下载源码包</span></span><br><span class="line"><span class="comment"># gcc 和 make 用于编译</span></span><br><span class="line">yum install wget gcc make</span><br><span class="line"></span><br><span class="line"><span class="comment">#make报错，Python 有个很重要的内建模块 zipimport 用于从 Zip 压缩包中导入模块</span></span><br><span class="line"><span class="comment">#zipimport.ZipImportError: can't decompress data; zlib not available</span></span><br><span class="line">yum install zlib-devel</span><br><span class="line"></span><br><span class="line"><span class="comment">#make install报错，</span></span><br><span class="line"><span class="comment">#ModuleNotFoundError: No module named ‘_ctypes’</span></span><br><span class="line">yum install libffi-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决 import ssl 报错 No module named '_ssl'</span></span><br><span class="line">yum install openssl-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决 import bz2 报错</span></span><br><span class="line">yum install  bzip2-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决 import curses 报错</span></span><br><span class="line">yum install  ncurses-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决 import sqlite3 报错</span></span><br><span class="line">yum install sqlite-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决 _dbm _gdbm 缺失提醒</span></span><br><span class="line">yum install gdbm-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决 _lzma 缺失提醒</span></span><br><span class="line">yum install xz-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决 _tkinter 缺失提醒</span></span><br><span class="line">yum install tk-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决 readline 缺失提醒及方向键行为非预期的问题</span></span><br><span class="line">yum install readline-devel</span><br></pre></td></tr></table></figure><p>然后下载源码包</p><p><code>wget https://www.python.org/ftp/python/3.7.1/Python-3.7.1.tar.xz</code></p><p>解压缩</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xz -d Python-3.7.1.tar.xz</span><br><span class="line">tar -xvf Python-3.7.1.tar</span><br></pre></td></tr></table></figure><p>编译&amp;安装</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> Python-3.7.1</span><br><span class="line"><span class="comment">#--prefix 是预期安装目录，--enable-optimizations 是优化选项（LTO，PGO 等）</span></span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/python3.7 --<span class="built_in">enable</span>-optimizations</span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>添加软链接</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/<span class="built_in">local</span>/python3.7/bin/python3.7 /usr/bin/python3</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/python3.7/bin/pip3.7 /usr/bin/pip3</span><br></pre></td></tr></table></figure><p>这样子应该一切就搞定啦。<br>然而，事情好像没有那么简单。</p><p>当我尝试使用 <code>pip3 install flask</code> 的时候，报错。</p><h2 id="Error-OpenSSL-version"><a href="#Error-OpenSSL-version" class="headerlink" title="Error - OpenSSL version"></a>Error - OpenSSL version</h2><blockquote><p>pip is configured with locations that require TLS/SSL, however the ssl module in Python is not available.</p></blockquote><p>前边说过，我的服务器系统是CentOS 6，默认的OpenSSL版本是1.0.1，而Python3.7需要OpenSSL1.0.2或者1.1.x才行，于是我们需要对OpenSSL进行升级并且重新编辑Pyton3.7。</p><h2 id="升级OpenSSL"><a href="#升级OpenSSL" class="headerlink" title="升级OpenSSL"></a>升级OpenSSL</h2><p>下载最新版的OpenSSL</p><p><code>wget https://www.openssl.org/source/openssl-1.1.1-pre8.tar.gz</code></p><p>编译&amp;安装</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> openssl-1.1.1-pre8</span><br><span class="line">./config --prefix=/usr/<span class="built_in">local</span>/openssl no-zlib <span class="comment">#不需要zlib</span></span><br><span class="line">make &amp; make install</span><br></pre></td></tr></table></figure><p>备份原配置</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/bin/openssl /usr/bin/openssl.bak</span><br><span class="line">mv /usr/include/openssl/ /usr/include/openssl.bak</span><br></pre></td></tr></table></figure><p>添加软链接</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/<span class="built_in">local</span>/openssl/include/openssl /usr/include/openssl</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/openssl/lib/libssl.so.1.1 /usr/<span class="built_in">local</span>/lib64/libssl.so</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/openssl/bin/openssl /usr/bin/openssl</span><br></pre></td></tr></table></figure><p>修改系统配置</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#写入openssl库文件的搜索路径</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/usr/local/openssl/lib"</span> &gt;&gt; /etc/ld.so.conf</span><br><span class="line"><span class="comment">#使修改后的/etc/ld.so.conf生效 </span></span><br><span class="line">ldconfig -v</span><br></pre></td></tr></table></figure><p>重新编译Python3.7</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> Python-3.7.1</span><br><span class="line"><span class="comment">#--prefix 是预期安装目录，--enable-optimizations 是优化选项（LTO，PGO 等）</span></span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/python3.7 --<span class="built_in">enable</span>-optimizations  --with-openssl=/usr/<span class="built_in">local</span>/openssl</span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p><strong>至此，所有问题都解决了。</strong><br><strong>感想：Linux里的相关环境配置，真是一门大学问啊</strong></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><em><a href="https://blog.tanteng.me/2015/12/flask-sslcontext/" target="_blank" rel="noopener">Flask安装: A true SSLContext object is not available</a></em><br><em><a href="https://segmentfault.com/a/1190000017313144" target="_blank" rel="noopener">CentOS 7 下安装 Python3.7.1</a></em><br><em><a href="https://blog.51cto.com/13544424/2149473" target="_blank" rel="noopener">python3.7安装后ssl问题</a></em></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;这两天在倒腾用Python写个接口，遇到一些问题，特此做下记录备忘，方便后面查阅。&lt;/p&gt;
&lt;h2 id=&quot;Error-A-true-SSLContext-object-is-not-available&quot;&gt;&lt;a href=&quot;#Error-A-true-SSLContext-
      
    
    </summary>
    
    
      <category term="Python" scheme="https://shixiong.name/tags/Python/"/>
    
      <category term="Flask" scheme="https://shixiong.name/tags/Flask/"/>
    
      <category term="OpenSSL" scheme="https://shixiong.name/tags/OpenSSL/"/>
    
      <category term="Linux" scheme="https://shixiong.name/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Sublime Text 使用备忘</title>
    <link href="https://shixiong.name/2018/12/24/sublimetext-remind/"/>
    <id>https://shixiong.name/2018/12/24/sublimetext-remind/</id>
    <published>2018-12-24T13:56:15.000Z</published>
    <updated>2019-07-30T02:17:17.770Z</updated>
    
    <content type="html"><![CDATA[<h3 id="快捷键备忘"><a href="#快捷键备忘" class="headerlink" title="快捷键备忘"></a>快捷键备忘</h3><ul><li>【control+tab】：在tab之间切换</li><li>【command+j】：合并两行</li><li>【command+l】：选择当前行</li><li>【command+enter】：下一行开辟新行</li><li>【shift+command+enter】：上一行开辟新行</li><li>【option+鼠标左键】：块选择并进入多点编辑模式</li><li>【option+左右键】：移动一个单词（+shift 同时进行选择）</li><li>【command+左右键】：行首行位切换</li><li>【shift+command+p】：在命令中直接输入文档类型（如css等可直接切换）</li><li>【shift+command+p】：reindent lines 代码风格缩进</li></ul><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>那么如何绑定快捷键呢，首先 <code>shift+command+p</code> 打开命令面板，输入<code>keybindings</code>，点击 <code>Key Bindings - User</code>，在配置文件中加入 <code>[{&quot;key&quot;: [&quot;shift+tab&quot;], &quot;command&quot;: &quot;reindent&quot;, &quot;agrs&quot;: {&quot;single_line&quot;: false }},]</code>。</p><p>那么如何知道具体命令是什么呢？<br>可以通过 </p><pre><code>control+`</code></pre><p>打开工作台，在工作台中输入 <code>sublime.log_commands(True)</code>，然后再通过<code>shift+command+p</code>打开命令面板，输入 <code>reindent lines</code>, 就可以在下边的工作台中看到具体命令名及参数了。</p><p><strong>那么所有的配置都保存到哪了呢？</strong></p><p>可以点击左上角的 <code>Sublime Text - Preferences - browse Packages...</code><br>这个时候应该会打开到这个目录下 <code>~/Library/Application Support/Sublime Text 3/Packages</code>，具体的根据环境不同路径会不同。</p><p>在该目录下，用户的所有配置项会存在<code>User</code>文件夹中，并且这些配置文件都是纯文本的，所以可以支持版本控制。</p><p>除了这个之外，还有一些自定义项也可以通过 <code>shift+command+p</code> 打开命令面板，输入 <code>settings</code> 打开 <code>Preferences: Settings - User</code> 便可找到配置自定义配置项的配置文件了。</p><h3 id="使用Packages-Control安装扩展包"><a href="#使用Packages-Control安装扩展包" class="headerlink" title="使用Packages Control安装扩展包"></a>使用Packages Control安装扩展包</h3><p>安装 <code>Packages Control</code> 的方法可以参考这个 <a href="https://packagecontrol.io/installation" target="_blank" rel="noopener">Installation - Package Control</a></p><p>官网上也有很多库可供选择。安装完<code>Packages Control</code>之后，包都会存放在 <code>~/Library/Application Support/Sublime Text 3/Packages</code> 里边的 <code>Installed Packages</code> 里。并且会在 <code>Packages/User</code> 里新加一个 <code>Packge Control.sublime-settings</code> 配置项。</p><p>推荐的一些扩展包</p><blockquote><p><code>AdvancedNewFile</code><br><code>Emmet</code><br><code>Git</code><br><code>Sass</code><br><code>SublimeERB</code><br><code>SyncedSideBar</code></p></blockquote><h3 id="快速查找"><a href="#快速查找" class="headerlink" title="快速查找"></a>快速查找</h3><p>正常情况下，可以通过 <code>command+p</code> 直接输入模糊搜索：</p><blockquote><p>eg: 模糊搜索名+冒号+行号，如：<code>demo:10</code>，光标会直接停在第10行<br>eg: 搜索名@函数名会跳转到函数名，如：<code>demo@new</code></p></blockquote><p>可以通过 <code>command+f</code> 在本文件中进行查找：</p><blockquote><p><code>enter</code>：搜索下一处；<code>shift+enter</code>：搜索上一处；<code>esc</code>：停在当前单词<br><code>command+d</code> n次，可以同时编辑，并进入多点编辑</p></blockquote><p>要在文件夹下查找的话，需要在文件夹上右键，点击 <code>find in finder</code>，会把相应的内容记在一个文本里，按<code>F4</code>可以跳转到第一个查找项，或者也可以直接在文本里用鼠标双击打开。</p><p>跳走了可以用 <code>control+-</code> 直接跳回去。<br>如果跳多了，可以 <code>control+shift+-</code> 可以再进行回到上一级的操作。</p><h3 id="Emmet"><a href="#Emmet" class="headerlink" title="Emmet"></a>Emmet</h3><p>牛逼！（todo）</p><h3 id="代码片段"><a href="#代码片段" class="headerlink" title="代码片段"></a>代码片段</h3><p>（todo）</p><h3 id="自动补齐"><a href="#自动补齐" class="headerlink" title="自动补齐"></a>自动补齐</h3><p>（todo）</p><p>/user下的 <code>damemon.sublime-completions</code></p><p>sublimeCodeIntel</p><h3 id="build-system"><a href="#build-system" class="headerlink" title="build system"></a>build system</h3><p>（todo）</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;快捷键备忘&quot;&gt;&lt;a href=&quot;#快捷键备忘&quot; class=&quot;headerlink&quot; title=&quot;快捷键备忘&quot;&gt;&lt;/a&gt;快捷键备忘&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;【control+tab】：在tab之间切换&lt;/li&gt;
&lt;li&gt;【command+j】：合并两行&lt;/li
      
    
    </summary>
    
    
      <category term="sublime text" scheme="https://shixiong.name/tags/sublime-text/"/>
    
  </entry>
  
  <entry>
    <title>与Cocoapods抗战的一天</title>
    <link href="https://shixiong.name/2018/05/22/fight-with-cocoapods/"/>
    <id>https://shixiong.name/2018/05/22/fight-with-cocoapods/</id>
    <published>2018-05-22T14:43:54.000Z</published>
    <updated>2019-07-30T02:17:17.769Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>在升级Mac系统到macOS High Sierra（10.13.4）的时候，出现升级失败导致开不了机，所有的数据全没了。<br>🌶🐔🍎💊<br>之前的系统环境都要全部重新配置，在配置cocoapods的时候遇到了一些问题，特此记录。</p></blockquote><h2 id="安装cocoapods依赖的环境"><a href="#安装cocoapods依赖的环境" class="headerlink" title="安装cocoapods依赖的环境"></a>安装cocoapods依赖的环境</h2><p>这步网上有很多<a href="https://www.google.com.hk/search?q=%E5%AE%89%E8%A3%85cocoapods&amp;oq=%E5%AE%89%E8%A3%85cocoapods&amp;aqs=chrome..69i57j69i61j0.3420j0j4&amp;sourceid=chrome&amp;ie=UTF-8" target="_blank" rel="noopener">教程</a>，就不再赘述。<br>然而安装完后，在执行 <code>pod install</code> 或 <code>pod update</code> 时，就会出现如下错误：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ArgumentError - Malformed version number string</span><br><span class="line">/Library/Ruby/Site/2.3.0/rubygems/version.rb:209:in `initialize&apos;</span><br><span class="line">/Library/Ruby/Site/2.3.0/rubygems/version.rb:200:in `new&apos;</span><br><span class="line">/Library/Ruby/Site/2.3.0/rubygems/version.rb:200:in `new&apos;</span><br><span class="line">/Library/Ruby/Gems/2.3.0/gems/cocoapods-1.5.2/lib/cocoapods/generator/xcconfig/aggregate_xcconfig.rb:123:in `embedded_content_settings&apos;</span><br><span class="line">/Library/Ruby/Gems/2.3.0/gems/cocoapods-1.5.2/lib/cocoapods/generator/xcconfig/aggregate_xcconfig.rb:68:in `generate&apos;</span><br><span class="line">/Library/Ruby/Gems/2.3.0/gems/cocoapods-1.5.2/lib/cocoapods/generator/xcconfig/aggregate_xcconfig.rb:39:in `save_as&apos;</span><br><span class="line">...</span><br><span class="line">/Library/Ruby/Gems/2.3.0/gems/cocoapods-1.5.2/lib/cocoapods/installer.rb:183:in `generate_pods_project&apos;</span><br><span class="line">/Library/Ruby/Gems/2.3.0/gems/cocoapods-1.5.2/lib/cocoapods/installer.rb:119:in `install!&apos;</span><br><span class="line">/Library/Ruby/Gems/2.3.0/gems/cocoapods-1.5.2/lib/cocoapods/command/install.rb:41:in `run&apos;</span><br><span class="line">/Library/Ruby/Gems/2.3.0/gems/claide-1.0.2/lib/claide/command.rb:334:in `run&apos;</span><br><span class="line">/Library/Ruby/Gems/2.3.0/gems/cocoapods-1.5.2/lib/cocoapods/command.rb:52:in `run&apos;</span><br><span class="line">/Library/Ruby/Gems/2.3.0/gems/cocoapods-1.5.2/bin/pod:55:in `&lt;top (required)&gt;&apos;</span><br><span class="line">/usr/bin/pod:23:in `load&apos;</span><br><span class="line">/usr/bin/pod:23:in `&lt;main&gt;&apos;</span><br></pre></td></tr></table></figure><p>（一脸懵逼…）</p><p>Google搜了一堆也没找到解决办法，后来在Cocoapods的issues里找到<a href="https://github.com/CocoaPods/CocoaPods/issues/7756" target="_blank" rel="noopener">一个解决方案</a>:</p><blockquote><p>jcharr1: I came across this issue today, too, when trying to run “pod install.” What version of Rubygems are you running? For me, I had updated with <code>gem update --system</code> which brought me up to v2.7.7. Downgrading to 2.7.6 with <code>gem update --system 2.7.6</code> fixed this for me.</p></blockquote><p>这位 <code>jcharr1</code> 说gem版本太高了导致的，他降级到2.7.6就可以了。于是我也尝试着降级了一下，果然解决了！不过其中缘由不得而知，有时间再研究一下。</p><h2 id="Pod-install"><a href="#Pod-install" class="headerlink" title="Pod install"></a>Pod install</h2><p>现在可以正常 <code>pod install</code> 和 <code>pod update</code> 了吗？并不。<br>当我按下回车键之后，又出现了一个小问题：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Analyzing dependencies</span><br><span class="line">Pre-downloading: `XXXX` from `http://xxx.com/xxx/xxx.git`, tag `xxx_6.9.5`</span><br><span class="line">Username for &apos;http://xxx.com&apos;: aaa</span><br><span class="line">Password for &apos;http://aaa@xxx.com&apos;:</span><br></pre></td></tr></table></figure><p>其实这个输入账号密码就能解决问题了，但是我比较好奇的是我已经有添加了 <code>SSH Key</code>，为什么还会要我输入账号密码呢？原来，当我们的pod组件的地址使用的是 <code>http/https</code> 地址的时候，就会使用账号密码验证，当使用ssh地址的时候，就会用 <code>SSH Key</code> 验证。<br>所以当我们不想输入账号密码的时候，可以在 <code>~/.gitconfig</code> 中加入如下代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[url &quot;git@github.com:&quot;]</span><br><span class="line">  insteadOf = https://github.com/</span><br><span class="line">[url &quot;git@github.com:&quot;]</span><br><span class="line">  pushInsteadOf = &quot;git://github.com/&quot;</span><br><span class="line">[url &quot;git@github.com:&quot;]</span><br><span class="line">  pushInsteadOf = &quot;https://github.com/&quot;</span><br></pre></td></tr></table></figure><p>相关地址可以根据具体情况具体修改，修改完之后就会强制使用 <code>ssh</code> 验证了。</p><p>然后 <code>pod install</code>，可以了吗？不！它又出错了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[!] Error installing MTCameraAR</span><br><span class="line">[!] Failed to download &apos;MTCameraAR&apos;</span><br></pre></td></tr></table></figure><p>（一脸懵逼again…）</p><p>后来尝试卸载重装cocoapods，都不行。正当无可奈何之际，突然想起来，pod有 <code>--verbose</code> 这个参数啊，说不定会有帮助。<br>于是 <code>pod install --verbose</code></p><p><img src="http://7viin1.com1.z0.glb.clouddn.com/pic.png" alt=""></p><p>关键的错误就出现了， <code>git-lfs: command not found</code><br>由于这个库的文件都很大，没有使用git-lfs的话会超时，无法成功拉取。所以只要<a href="https://github.com/git-lfs/git-lfs/wiki/Installation" target="_blank" rel="noopener">安装git-lfs</a>就好了。</p><p>bingo！问题都解决了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;在升级Mac系统到macOS High Sierra（10.13.4）的时候，出现升级失败导致开不了机，所有的数据全没了。&lt;br&gt;🌶🐔🍎💊&lt;br&gt;之前的系统环境都要全部重新配置，在配置cocoapods的时候遇到了一些问题，特此记录。&lt;/p
      
    
    </summary>
    
    
      <category term="iOS" scheme="https://shixiong.name/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>用 Swift 协议扩展和泛型来实现复用[译]</title>
    <link href="https://shixiong.name/2016/11/11/yong-swift-xieyi-tuozhan-fuyong/"/>
    <id>https://shixiong.name/2016/11/11/yong-swift-xieyi-tuozhan-fuyong/</id>
    <published>2016-11-11T12:56:15.000Z</published>
    <updated>2019-07-30T02:17:17.771Z</updated>
    
    <content type="html"><![CDATA[<p>作为一个iOS开发者，最常用的任务就是通过自定义cell的子类，来实现UITableView或者UICollectionView的自定义。并且 <code>UITableView</code> 和 <code>UICollectionView</code> 在注册自定义cell子类这一块都有非常类似的API:</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">registerClass</span><span class="params">(cellClass: AnyClass?, forCellWithReuseIdentifier identifier: String)</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">registerNib</span><span class="params">(nib: UINib?, forCellWithReuseIdentifier identifier: String)</span></span></span><br></pre></td></tr></table></figure><p>对于注册cell的自定义最常用的解决办法就是，声明一个reuseIdentifier的常量，像下面这样: </p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">let</span> reuseIdentifier = <span class="string">"BookCell"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookListViewController</span>: <span class="title">UIViewController</span>, <span class="title">UICollectionViewDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">private</span> <span class="keyword">weak</span> <span class="keyword">var</span> collectionView: <span class="type">UICollectionView</span>!</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> nib = <span class="type">UINib</span>(nibName: <span class="string">"BookCell"</span>, bundle: <span class="literal">nil</span>)</span><br><span class="line">        <span class="keyword">self</span>.collectionView.registerNib(nib, forCellWithReuseIdentifier: reuseIdentifier)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(collectionView: UICollectionView, cellForItemAtIndexPath indexPath: NSIndexPath)</span></span> -&gt; <span class="type">UICollectionViewCell</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> cell = collectionView.dequeueReusableCellWithReuseIdentifier(reuseIdentifier, forIndexPath: indexPath)</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> bookCell = cell <span class="keyword">as</span>? <span class="type">BookCell</span> &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> configure cell</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> cell</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来让我们尝试着使用泛型来让它简单化和安全化。  </p><p>首先，如果在我们的代码当中能不需要到处声明reuse identifier常量，那就再好不过了。而事实上，我们可以直接使用自定义cell的类名来当做   <strong>默认的reuseIdentifier</strong>。<br>我们可以通过创建一个Reuseable Views的协议并且创建默认的声明方法给 <code>UIView</code> 的子类们。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">ReusableView</span>: <span class="title">class</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> defaultReuseIdentifier: <span class="type">String</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ReusableView</span> <span class="title">where</span> <span class="title">Self</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> defaultReuseIdentifier: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">NSStringFromClass</span>(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UICollectionViewCell</span>: <span class="title">ReusableView</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过让 <code>UICollectionViewCell</code> 遵循 <code>ReusableView</code> 协议，我们可以得到每个cell子类的一个唯一的重用标识。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> identifier = <span class="type">BookCell</span>.defaultReuseIdentifier</span><br><span class="line"><span class="comment">// identifier = "MyModule.BookCell"</span></span><br></pre></td></tr></table></figure><p>接下来，我们通过同样的方法，将注册Nib步骤中的一些脏代码给去除掉。  </p><p>我们创建一个 <strong>Nib Loadable Views</strong> 的协议并通过协议拓展添加一个默认方法实现。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">NibLoadableView</span>: <span class="title">class</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> nibName: <span class="type">String</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">NibLoadableView</span> <span class="title">where</span> <span class="title">Self</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> nibName: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">NSStringFromClass</span>(<span class="keyword">self</span>).componentsSeparatedByString(<span class="string">"."</span>).last!</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">BookCell</span>: <span class="title">NibLoadableView</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过让我们的 <code>BookCell</code> 类遵循 <code>NibLoadableView</code> 协议，现在我们就有了一个更安全和方便的方法去获得到Nib的名称。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> nibName = <span class="type">BookCell</span>.nibName</span><br><span class="line"><span class="comment">// nibName = "BookCell"</span></span><br></pre></td></tr></table></figure><p>有这两个协议，我们可以通过使用 <strong>Swift的泛型</strong> 并且通过拓展 <code>UICollectionView</code> 来简化cell的注册和使用。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UICollectionView</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">register</span>&lt;T: UICollectionViewCell where T: ReusableView&gt;<span class="params">(<span class="number">_</span>: T.<span class="keyword">Type</span>)</span></span> &#123;</span><br><span class="line">        registerClass(<span class="type">T</span>.<span class="keyword">self</span>, forCellWithReuseIdentifier: <span class="type">T</span>.defaultReuseIdentifier)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">register</span>&lt;T: UICollectionViewCell where T: ReusableView, T: NibLoadableView&gt;<span class="params">(<span class="number">_</span>: T.<span class="keyword">Type</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> bundle = <span class="type">NSBundle</span>(forClass: <span class="type">T</span>.<span class="keyword">self</span>)</span><br><span class="line">        <span class="keyword">let</span> nib = <span class="type">UINib</span>(nibName: <span class="type">T</span>.nibName, bundle: bundle)</span><br><span class="line">        </span><br><span class="line">        registerNib(nib, forCellWithReuseIdentifier: <span class="type">T</span>.defaultReuseIdentifier)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">dequeueReusableCell</span>&lt;T: UICollectionViewCell where T: ReusableView&gt;<span class="params">(forIndexPath indexPath: NSIndexPath)</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> cell = dequeueReusableCellWithReuseIdentifier(<span class="type">T</span>.defaultReuseIdentifier, forIndexPath: indexPath) <span class="keyword">as</span>? <span class="type">T</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">fatalError</span>(<span class="string">"Could not dequeue cell with identifier: \(T.defaultReuseIdentifier)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> cell</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意这里，我们创建了两个版本的注册方法，一个是用来注册 <code>ReusableView</code> 子类用的，一个是用来注册 <code>ReusableView</code> 和 <code>NibLoadableView</code>的子类。这很好的将view controller的特定的注册方法分离出来。</p><p>另一个比较棒的细节就是 <code>dequeueReusableCell</code> 方法不再需要给他任何重用标识字符串而且可以直接使用cell的子类作为返回值。</p><p>现在cell的注册和使用代码看起来棒极了 :) 。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookListViewController</span>: <span class="title">UIViewController</span>, <span class="title">UICollectionViewDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">private</span> <span class="keyword">weak</span> <span class="keyword">var</span> collectionView: <span class="type">UICollectionView</span>!</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.collectionView.register(<span class="type">BookCell</span>.<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(collectionView: UICollectionView, cellForItemAtIndexPath indexPath: NSIndexPath)</span></span> -&gt; <span class="type">UICollectionViewCell</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> cell: <span class="type">BookCell</span> = collectionView.dequeueReusableCell(forIndexPath: indexPath)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> configure cell</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> cell</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>如果你是从 Objective-C 转到 Swift 的话，研究Swift强大的新特性比如 <strong>协议拓展</strong>、 <strong>泛型</strong>， 从而找到更优雅的实现方式和替代方法是非常值得的。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;作为一个iOS开发者，最常用的任务就是通过自定义cell的子类，来实现UITableView或者UICollectionView的自定义。并且 &lt;code&gt;UITableView&lt;/code&gt; 和 &lt;code&gt;UICollectionView&lt;/code&gt; 在注册自定义ce
      
    
    </summary>
    
    
      <category term="iOS" scheme="https://shixiong.name/tags/iOS/"/>
    
      <category term="Swift" scheme="https://shixiong.name/tags/Swift/"/>
    
  </entry>
  
  <entry>
    <title>贝塞尔曲线指北</title>
    <link href="https://shixiong.name/2016/11/03/bezier-zhibei/"/>
    <id>https://shixiong.name/2016/11/03/bezier-zhibei/</id>
    <published>2016-11-03T09:37:01.000Z</published>
    <updated>2019-07-30T02:17:17.743Z</updated>
    
    <content type="html"><![CDATA[<p>最近在做项目的时候，需要用到一个动画，非常简单的动画，简单到就是直接对一个View做平移… 然而虽然动画简单，但是却很不自然，尝试了UIView Animation提供的各类参数，都无法达到想要的动画效果。这时候，我的脑子里突然想起一个词… “贝塞尔曲线”…. 这个词经常看到，但却从没有去了解过，这次就趁着有求于它的雅兴，好好做个入门了解好了。</p><h2 id="什么是贝塞尔曲线？"><a href="#什么是贝塞尔曲线？" class="headerlink" title="什么是贝塞尔曲线？"></a>什么是贝塞尔曲线？</h2><p>  显而易见的是，贝塞尔曲线，应该就是是一个叫贝塞尔的人发明的曲线吧，然而历史剧本却不是这么写的。贝塞尔曲线所依据的最原始的数学公式，是早在1912年就广为人知的伯恩斯坦多项式。OK，now，What is boensitan duoxiangshi？！简单来说，伯恩斯坦多项式可以用来证明，在[ a, b ] 区间上所有的连续函数都可以用多项式来逼近，并且收敛性很强，也就是一致收敛。再简单点，就是一个连续函数，你可以将它写成若干个伯恩斯坦多项式相加的形式，并且，随着 n→∞，这个多项式将一致收敛到原函数，这个就是伯恩斯坦斯的逼近性质。<br>  不知道在说什么鬼？没关系，接着说..<br>  到了1959年，当时就职于雪铁龙的法国数学家 Paul de Casteljau 开始对伯恩斯坦多项式进行了图形化的尝试，并且提供了一种数值稳定的德卡斯特里奥（de Casteljau） 算法。根据这个算法，就可以只通过很少的控制点，去生成复杂的平滑曲线，也就是贝塞尔曲线。<br>  而贝塞尔曲线的得名，得归功于1962年就职于雷诺的法国工程师皮埃尔·贝塞尔（Pierre Bézier），他使用这种方法来辅助汽车的车体工业设计，并且广泛宣传，因此大家才都称他为贝塞尔曲线  。</p><h2 id="贝塞尔曲线是怎么画出来的？"><a href="#贝塞尔曲线是怎么画出来的？" class="headerlink" title="贝塞尔曲线是怎么画出来的？"></a>贝塞尔曲线是怎么画出来的？</h2><p>首先，我们在平面内选3个不同线的点并且依次用线段连接。如下所示..<br><img src="56030-48977fcfcd8cd57e.png" alt=""><br>接着，我们在AB和BC线段上找出点D和点E，使得AD/AB = BE/BC。<br><img src="56030-5d3e252f34e657c9.jpg" alt=""><br>再接着，连接DE，并在DE上找出一点F，使得DF/DE =  AD/AB = BE/BC。<br><img src="56030-5175f6c03d4990b2.jpg" alt=""><br>然后，根据我们高中所学的极限的知识，让选取的点D在第一条线段上从起点A，移动到终点B，找出所有点F，并将它们连起来。最后你会发现，你得到了一条非常光滑的曲线，这条就是传说中的，贝塞尔曲线。<br>看这里…  </p><p><img src="56030-bb6b8c6a46f12135.gif" alt=""></p><p>这是二阶贝塞尔曲线。  </p><p>下面是三阶四阶和五阶。  </p><p><img src="56030-f3e69b487f4e37c8.gif" alt="">  </p><p><img src="56030-2d2fb8989e10f177.gif" alt="">  </p><p><img src="56030-390b7b874ddd5d3d.gif" alt="">  </p><p>最后是… 一阶….  </p><p><img src="56030-b65e3dd8196f4da5.gif" alt="">  </p><p>所以贝塞尔曲线的厉害之处就在这里，从1-n阶的连续函数，他都可以计算得到一条光滑曲线。</p><h2 id="贝塞尔曲线有什么用？为什么经常会听到这个名称？"><a href="#贝塞尔曲线有什么用？为什么经常会听到这个名称？" class="headerlink" title="贝塞尔曲线有什么用？为什么经常会听到这个名称？"></a>贝塞尔曲线有什么用？为什么经常会听到这个名称？</h2><p>由于贝塞尔曲线控制简便，而且它具有很强的描述能力，因此它在工业设计上已经被广泛使用了。不仅如此，在计算机图形学领域（特别是矢量图形学），贝塞尔曲线也有着举足轻重的地位。而作为程序猿，我们经常会用贝塞尔曲线来绘图（由贝塞尔曲线画出来的图很光滑~），来做动画（很自然的动画）等等。也就是由于它可以发挥的作用领域太广了，因此我们时不时都会听到这个名字。</p><h2 id="如何使用贝塞尔曲线？"><a href="#如何使用贝塞尔曲线？" class="headerlink" title="如何使用贝塞尔曲线？"></a>如何使用贝塞尔曲线？</h2><p>首先，要明确的一点是，对于贝塞尔曲线来说，最重要的点是，数据点和控制点。<br>数据点： 指一条路径的起始点和终止点。<br>控制点：控制点决定了一条路径的弯曲轨迹，根据控制点的个数，贝塞尔曲线被分为一阶贝塞尔曲线（0个控制点）、二阶贝塞尔曲线（1个控制点）、三阶贝塞尔曲线（2个控制点）等等。<br>而系统给我们提供了一个叫做UIBezierPath类，用它可以画简单的圆形，椭圆，矩形，圆角矩形，也可以通过添加点去生成任意的图形，还可以简单的创建一条二阶贝塞尔曲线和三阶贝塞尔曲线。</p><h3 id="用法1：简单地画图形"><a href="#用法1：简单地画图形" class="headerlink" title="用法1：简单地画图形"></a>用法1：简单地画图形</h3><p>这里的简单用法就不细讲，虽然类名叫UIBezierPath，但画圆形啥的跟贝塞尔也没啥关系，直接贴代码。  </p><ul><li>画圆形      </li></ul><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UIBezierPath</span> *bPath = [<span class="built_in">UIBezierPath</span> bezierPathWithArcCenter:<span class="built_in">CGPointMake</span>(<span class="number">300</span>, <span class="number">300</span>) radius:<span class="number">50</span></span><br><span class="line">                                            startAngle: DEGREES_TO_RADIANS(<span class="number">135</span>) endAngle:M_PI*<span class="number">2</span> clockwise:<span class="literal">YES</span>];</span><br><span class="line">   [bPath setLineWidth:<span class="number">5</span>];</span><br><span class="line">   <span class="comment">//绘制</span></span><br><span class="line">   [bPath stroke];</span><br></pre></td></tr></table></figure><ul><li>画椭圆</li></ul><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UIBezierPath</span> *ovalPath = [<span class="built_in">UIBezierPath</span> bezierPathWithOvalInRect:<span class="built_in">CGRectMake</span>(<span class="number">200</span>, <span class="number">150</span>, <span class="number">100</span>, <span class="number">200</span>)];</span><br><span class="line">   [ovalPath setLineWidth:<span class="number">5</span>];</span><br><span class="line">   [ovalPath stroke];</span><br></pre></td></tr></table></figure><ul><li>画矩形</li></ul><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UIBezierPath</span> *myBezierPath = [<span class="built_in">UIBezierPath</span> bezierPathWithRect:<span class="built_in">CGRectMake</span>(<span class="number">20</span>, <span class="number">20</span>, <span class="number">100</span>, <span class="number">50</span>)];</span><br><span class="line">  </span><br><span class="line">   [[<span class="built_in">UIColor</span> blackColor]setStroke];</span><br><span class="line">   [myBezierPath setLineWidth:<span class="number">5</span>];</span><br><span class="line">   [myBezierPath stroke];</span><br></pre></td></tr></table></figure><ul><li>画圆角矩形</li></ul><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//UIRectCorner可以设置 哪几个角是圆角，其他不变  </span></span><br><span class="line"> <span class="built_in">UIBezierPath</span> *tBPath = [<span class="built_in">UIBezierPath</span> bezierPathWithRoundedRect:<span class="built_in">CGRectMake</span>(<span class="number">220</span>, <span class="number">20</span>, <span class="number">100</span>, <span class="number">100</span>)                                                 </span><br><span class="line"> byRoundingCorners:<span class="built_in">UIRectCornerTopLeft</span> | <span class="built_in">UIRectCornerBottomLeft</span> cornerRadii:<span class="built_in">CGSizeMake</span>(<span class="number">20</span>, <span class="number">20</span>)];</span><br><span class="line">     </span><br><span class="line">     [[<span class="built_in">UIColor</span> greenColor]setStroke];</span><br><span class="line">     [tBPath setLineWidth:<span class="number">5</span>];</span><br><span class="line">     [tBPath stroke];</span><br></pre></td></tr></table></figure><ul><li>通过任意点画任意图形</li></ul><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UIBezierPath</span>* aPath = [<span class="built_in">UIBezierPath</span> bezierPath];</span><br><span class="line">aPath.lineWidth = <span class="number">15.0</span>;</span><br><span class="line"> </span><br><span class="line">   aPath.lineCapStyle = kCGLineCapButt;  <span class="comment">//线条终点</span></span><br><span class="line">   <span class="comment">//round 圆形</span></span><br><span class="line">   <span class="comment">//butt 平的 默认值 把线连接到精准的终点</span></span><br><span class="line">   <span class="comment">//Square 平的，会把线延伸到终点再加上线宽的一半  </span></span><br><span class="line">   aPath.lineJoinStyle = kCGLineJoinBevel;  <span class="comment">//拐点处理</span></span><br><span class="line">   <span class="comment">//bevel 斜角斜面，角的外侧是平的不圆滑</span></span><br><span class="line">   <span class="comment">//miter 斜接 角的外侧是尖的</span></span><br><span class="line">   <span class="comment">//round 圆角</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment">//这是起点  </span></span><br><span class="line">   [aPath moveToPoint:<span class="built_in">CGPointMake</span>(<span class="number">100.0</span>, <span class="number">200.0</span>)];</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//添加点  </span></span><br><span class="line">   [aPath addLineToPoint:<span class="built_in">CGPointMake</span>(<span class="number">200.0</span>, <span class="number">240.0</span>)];</span><br><span class="line">   [aPath addLineToPoint:<span class="built_in">CGPointMake</span>(<span class="number">160</span>, <span class="number">340</span>)];</span><br><span class="line">   [aPath addLineToPoint:<span class="built_in">CGPointMake</span>(<span class="number">40.0</span>, <span class="number">340</span>)];</span><br><span class="line">   [aPath addLineToPoint:<span class="built_in">CGPointMake</span>(<span class="number">10.0</span>, <span class="number">240.0</span>)];</span><br><span class="line">   [aPath closePath]; <span class="comment">//第五条线通过调用closePath方法得到的</span></span><br><span class="line">     </span><br><span class="line">   [aPath stroke]; <span class="comment">//Draws line 根据坐标点连线</span></span><br></pre></td></tr></table></figure><ul><li>画二阶贝塞尔</li></ul><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UIBezierPath</span>* twoPath = [<span class="built_in">UIBezierPath</span> bezierPath];</span><br><span class="line">   twoPath.lineWidth = <span class="number">5.0</span>;<span class="comment">//宽度</span></span><br><span class="line">   twoPath.lineCapStyle = kCGLineCapRound;  <span class="comment">//线条拐角</span></span><br><span class="line">   twoPath.lineJoinStyle = kCGLineJoinRound;  <span class="comment">//终点处理</span></span><br><span class="line">   <span class="comment">//起始点</span></span><br><span class="line">   [twoPath moveToPoint:<span class="built_in">CGPointMake</span>(<span class="number">20</span>, <span class="number">100</span>)];</span><br><span class="line">   <span class="comment">//添加两个控制点</span></span><br><span class="line">   [twoPath addQuadCurveToPoint:<span class="built_in">CGPointMake</span>(<span class="number">220</span>, <span class="number">100</span>) controlPoint:<span class="built_in">CGPointMake</span>(<span class="number">170</span>, <span class="number">0</span>)];</span><br><span class="line">   <span class="comment">//划线</span></span><br><span class="line">   [twoPath stroke];</span><br></pre></td></tr></table></figure><ul><li>画三阶贝塞尔<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">UIBezierPath* bPath = [UIBezierPath bezierPath];</span><br><span class="line">   </span><br><span class="line">   bPath.lineWidth = 5.0;</span><br><span class="line">   bPath.lineCapStyle = kCGLineCapRound;  //线条拐角</span><br><span class="line">   bPath.lineJoinStyle = kCGLineCapRound;  //终点处理</span><br><span class="line">   //起始点</span><br><span class="line">   [bPath moveToPoint:CGPointMake(20, 250)];</span><br><span class="line">   </span><br><span class="line">   //添加两个控制点</span><br><span class="line">   [bPath addCurveToPoint:CGPointMake(350, 250) controlPoint1:CGPointMake(310, 200) controlPoint2:CGPointMake(210, 400)];</span><br><span class="line">   [bPath stroke];</span><br></pre></td></tr></table></figure></li></ul><h3 id="用法2：用贝塞尔曲线圆滑绘图"><a href="#用法2：用贝塞尔曲线圆滑绘图" class="headerlink" title="用法2：用贝塞尔曲线圆滑绘图"></a>用法2：用贝塞尔曲线圆滑绘图</h3><p>这个用法可以说是处女座的福音。<br>假设这么一个场景：产品提了个需求，来吧，咱们来做一个你画我猜的APP。你画我猜？肯定是要先有画了。简单！新建个UIView的子类，然后在它的初始化方法中创建Path和手势。  </p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a path to connect lines</span></span><br><span class="line">path = [<span class="built_in">UIBezierPath</span> bezierPath];</span><br><span class="line"><span class="comment">// Capture touches</span></span><br><span class="line"><span class="built_in">UIPanGestureRecognizer</span> *pan = [[<span class="built_in">UIPanGestureRecognizer</span> alloc] initWithTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(pan:)];</span><br><span class="line">pan.maximumNumberOfTouches = pan.minimumNumberOfTouches = <span class="number">1</span>;</span><br><span class="line">[<span class="keyword">self</span> addGestureRecognizer:pan];</span><br></pre></td></tr></table></figure><p>再将捕获到的pan事件location数据依次加入到path中，并且用直线连接两点。 </p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)pan:(<span class="built_in">UIPanGestureRecognizer</span> *)pan &#123;</span><br><span class="line">    <span class="built_in">CGPoint</span> currentPoint = [pan locationInView:<span class="keyword">self</span>];</span><br><span class="line">    <span class="keyword">if</span> (pan.state == <span class="built_in">UIGestureRecognizerStateBegan</span>) &#123;</span><br><span class="line">        [path moveToPoint:currentPoint];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pan.state == <span class="built_in">UIGestureRecognizerStateChanged</span>) &#123;</span><br><span class="line">        [path addLineToPoint:currentPoint];</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="keyword">self</span> setNeedsDisplay];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后画出轨迹。</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)drawRect:(<span class="built_in">CGRect</span>)rect &#123;</span><br><span class="line">     [[<span class="built_in">UIColor</span> blackColor] setStroke];</span><br><span class="line">     [path stroke];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>最后将这个view添加到控制器上，很开心的Command + R，让程序跑起来。</p><p>开始画~<br>然后你就会发现，画出来的曲线是这样的。。<br><img src="56030-c2894a2979862cd1.png" alt=""></p><p>WHAT THE FXXK!!<br>怎么可以有这么多锯齿。。<br>所以这个时候，贝塞尔曲线就很有用了。它的定义是可以找到两点之间的光滑曲线，因为我们之前手势移动的时候，两点之间都是使用直线连接，如果我们可以使用贝塞尔曲线连接，那应该就不会出现这个问题了。<br>试一下。<br>首先写一个计算中点的方法，我们到时会使用这个中点作为控制点。  </p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">CGPoint</span> midpoint(<span class="built_in">CGPoint</span> p0, <span class="built_in">CGPoint</span> p1) &#123;</span><br><span class="line">     <span class="keyword">return</span> (<span class="built_in">CGPoint</span>) &#123;</span><br><span class="line">         (p0.x + p1.x) / <span class="number">2.0</span>,</span><br><span class="line">         (p0.y + p1.y) / <span class="number">2.0</span></span><br><span class="line">     &#125;;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>最后将手势处理中的连接方式替换成使用贝塞尔曲线。</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)pan:(<span class="built_in">UIPanGestureRecognizer</span> *)pan &#123;</span><br><span class="line">     <span class="built_in">CGPoint</span> currentPoint = [pan locationInView:<span class="keyword">self</span>];</span><br><span class="line">     <span class="built_in">CGPoint</span> midPoint = midpoint(previousPoint, currentPoint);</span><br><span class="line"> </span><br><span class="line">     <span class="keyword">if</span> (pan.state == <span class="built_in">UIGestureRecognizerStateBegan</span>) &#123;</span><br><span class="line">         [path moveToPoint:currentPoint];</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pan.state == <span class="built_in">UIGestureRecognizerStateChanged</span>) &#123;</span><br><span class="line">         [path addQuadCurveToPoint:midPoint controlPoint:previousPoint];</span><br><span class="line">     &#125;</span><br><span class="line">     previousPoint = currentPoint;</span><br><span class="line">     [<span class="keyword">self</span> setNeedsDisplay];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>再Run一次…<br><img src="56030-de6fcb447ec49b87.png" alt=""></p><p>看，光滑多了~<br><strong>所以很多时候，当我们遇到画出的图形太不自然的时候，就可以试着用贝塞尔曲线解决这些问题，用到越高阶的曲线，画出的图形越光滑。</strong> </p><h3 id="用法3：用贝塞尔曲线做变形"><a href="#用法3：用贝塞尔曲线做变形" class="headerlink" title="用法3：用贝塞尔曲线做变形"></a>用法3：用贝塞尔曲线做变形</h3><p>网上看到的大多数比较酷炫的动画，都是通过修改曲线的控制点，对曲线进行变形而做的。<br>比如，我们要实现如下一个动画。<br><img src="56030-8fb7008726c62987.gif" alt=""></p><p>这个动画最难地方就是手势拖拽的时候，直线的变形，可以首先的想到的是使用贝塞尔。通过创建path，添加控制点画出曲线，然后通过更改控制点的位置来达到让曲线进行变形的目的。<br><img src="56030-9b189370ffbf5aec.gif" alt=""></p><p>如上图所示，这里添加了7个点，从左到右依次为l3、l2、l1、c、 r1、 r2、 r3。屏幕最左和最右两边的l3和r3没有在图中显示出来，然后我们就可以以l3和l2为控制点，从l3到l1建立一条二阶贝塞尔曲线，再以c和r1为控制点建一条从l3到r1的曲线，最后以r1和r2为控制点建一条从r1到r3的曲线。   主要代码如下：  </p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">CGPathRef</span>)currentPath &#123;</span><br><span class="line">     <span class="built_in">CGFloat</span> width = <span class="keyword">self</span>.view.bounds.size.width;</span><br><span class="line">     <span class="built_in">UIBezierPath</span> *path = [<span class="built_in">UIBezierPath</span> bezierPath];</span><br><span class="line">     </span><br><span class="line">     [path moveToPoint:<span class="built_in">CGPointMake</span>(<span class="number">0</span>, <span class="number">0</span>)];</span><br><span class="line">     [path addLineToPoint:<span class="built_in">CGPointMake</span>(<span class="number">0</span>, <span class="keyword">self</span>.l3ControlPointView.center.y)];</span><br><span class="line">     [path addCurveToPoint:<span class="keyword">self</span>.l1ControlPointView.center</span><br><span class="line">             controlPoint1:<span class="keyword">self</span>.l3ControlPointView.center</span><br><span class="line">             controlPoint2:<span class="keyword">self</span>.l2ControlPointView.center];</span><br><span class="line">     [path addCurveToPoint:<span class="keyword">self</span>.r1ControlPointView.center</span><br><span class="line">             controlPoint1:<span class="keyword">self</span>.cControlPointView.center</span><br><span class="line">             controlPoint2:<span class="keyword">self</span>.r1ControlPointView.center];</span><br><span class="line">     [path addCurveToPoint:<span class="keyword">self</span>.r3ControlPointView.center</span><br><span class="line">             controlPoint1:<span class="keyword">self</span>.r1ControlPointView.center</span><br><span class="line">             controlPoint2:<span class="keyword">self</span>.r2ControlPointView.center];</span><br><span class="line">     [path addLineToPoint:<span class="built_in">CGPointMake</span>(width, <span class="number">0</span>)];</span><br><span class="line">     [path closePath];</span><br><span class="line">     <span class="keyword">return</span> path.CGPath;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>建立好路径之后，就可以通过手势操作来修改控制点的坐标达到我们的目的了。<br>在这里也就是修改l3到r3的中心点坐标。主要代码如下：  </p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)panDidMove:(<span class="built_in">UIPanGestureRecognizer</span> *)gesture &#123;</span><br><span class="line">     <span class="keyword">if</span> (gesture.state == <span class="built_in">UIGestureRecognizerStateEnded</span> ||</span><br><span class="line">         gesture.state == <span class="built_in">UIGestureRecognizerStateFailed</span> ||</span><br><span class="line">         gesture.state == <span class="built_in">UIGestureRecognizerStateCancelled</span>) &#123;</span><br><span class="line">         </span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="built_in">CGFloat</span> additionalHeight = MAX([gesture translationInView:<span class="keyword">self</span>.view].y, <span class="number">0</span>);</span><br><span class="line">         <span class="built_in">CGFloat</span> waveHeight = MIN(additionalHeight*<span class="number">0.6</span>, kMaxWaveHeight);</span><br><span class="line">         <span class="built_in">CGFloat</span> baseHeight = kMiniHeight + additionalHeight - waveHeight;</span><br><span class="line">         <span class="built_in">CGFloat</span> locationX = [gesture locationInView:gesture.view].x;</span><br><span class="line">         </span><br><span class="line">         [<span class="keyword">self</span> layoutControlPoints:baseHeight waveHeight:waveHeight locationX:locationX];</span><br><span class="line">         [<span class="keyword">self</span> updateShapeLayer];</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> - (<span class="keyword">void</span>)layoutControlPoints:(<span class="built_in">CGFloat</span>)baseHeight</span><br><span class="line">                  waveHeight:(<span class="built_in">CGFloat</span>)waveHeight</span><br><span class="line">                   locationX:(<span class="built_in">CGFloat</span>)locationX &#123;</span><br><span class="line">     <span class="built_in">CGFloat</span> width = <span class="keyword">self</span>.view.bounds.size.width;</span><br><span class="line">     <span class="built_in">CGFloat</span> minLeftX = MIN(locationX-width/<span class="number">2</span>*<span class="number">0.28</span>, <span class="number">0</span>);</span><br><span class="line">     <span class="built_in">CGFloat</span> maxRightX = MAX(width+(locationX-width)/<span class="number">2</span> *<span class="number">0.28</span>, width);</span><br><span class="line">     <span class="built_in">CGFloat</span> leftPartWidth = locationX - minLeftX;</span><br><span class="line">     <span class="built_in">CGFloat</span> rightPartWidth = maxRightX - locationX;</span><br><span class="line">     </span><br><span class="line">     <span class="keyword">self</span>.l3ControlPointView.center = <span class="built_in">CGPointMake</span>(minLeftX, baseHeight);</span><br><span class="line">     <span class="keyword">self</span>.l2ControlPointView.center = <span class="built_in">CGPointMake</span>(minLeftX+leftPartWidth*<span class="number">0.44</span>, baseHeight);</span><br><span class="line">     <span class="keyword">self</span>.l1ControlPointView.center = <span class="built_in">CGPointMake</span>(minLeftX+leftPartWidth*<span class="number">0.71</span>, baseHeight+waveHeight*<span class="number">0.64</span>);</span><br><span class="line">     <span class="keyword">self</span>.cControlPointView.center = <span class="built_in">CGPointMake</span>(locationX, baseHeight+waveHeight*<span class="number">1.36</span>);</span><br><span class="line">     <span class="keyword">self</span>.r1ControlPointView.center = <span class="built_in">CGPointMake</span>(maxRightX-rightPartWidth*<span class="number">0.71</span>, baseHeight+waveHeight*<span class="number">0.64</span>);</span><br><span class="line">     <span class="keyword">self</span>.r2ControlPointView.center = <span class="built_in">CGPointMake</span>(maxRightX-(rightPartWidth*<span class="number">0.44</span>), baseHeight);</span><br><span class="line">     <span class="keyword">self</span>.r3ControlPointView.center = <span class="built_in">CGPointMake</span>(maxRightX, baseHeight);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> - (<span class="keyword">void</span>)updateShapeLayer &#123;</span><br><span class="line">     <span class="keyword">self</span>.shapeLayer.path = [<span class="keyword">self</span> currentPath];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>通过这个思路，我们可以做出很多有意思而且有生命力的动画，这里一般还会经常和 <code>CADisplayLink</code> 一起用，先留个坑。 </p><h3 id="用法4：用贝塞尔曲线做缓冲动画"><a href="#用法4：用贝塞尔曲线做缓冲动画" class="headerlink" title="用法4：用贝塞尔曲线做缓冲动画"></a>用法4：用贝塞尔曲线做缓冲动画</h3><p>做动画最主要的一点，就是要让动画达到很自然的效果。这就要涉及到一些现实中的物理知识，比如重力弹力和速度等等，所以有时候，我们需要对动画的速度进行控制，有时候需要先快再慢，有时候需要先慢再快然后再慢，有时候又需要快慢超慢非常慢…<br>这个时候就不得不提到 <code>CAMediaTimingFunction</code> 。<br><code>CAMediaTimingFunction</code> 的主要用法可以理解为我们在一个二维坐标系上建议一条或曲线或直线的函数，这个函数的斜率就是动画的速度，斜率的改变量也就是导数则为加速度。理论上来说，这个坐标系上的任何曲线都可以用来当做加速动画。然而<code>CAMediaTimingFunction</code> 只给我们提供了一个三次贝塞尔曲线的函数，它可以生成三次贝塞尔曲线所能生成的所有缓冲函数。<br>这里刚好可以介绍 <del>一个</del> 两个好用的网站：  <a href="http://www.roblaplaca.com/examples/bezierBuilder" target="_blank" rel="noopener">http://www.roblaplaca.com/examples/bezierBuilder</a><br>这个网站可以做到可视化的修改两个控制点，来达到生成一条三阶贝塞尔曲线，并且还会给出两个控制点的具体坐标，以及右边还可以看到这条曲线产生的动画会做怎样的速度改变。也就是说，只要我们能拿到两个控制点的坐标，就可以用来控制动画了。<br><a href="http://easings.net/#" target="_blank" rel="noopener">http://easings.net</a><br>这个网站提供了丰富的曲线类型可供选择，图表旁还有一个小动画预览，非常直观。<br>比如下面这段代码，就可以让我们把相册从4：3 切换到1：1 的时候，展示一个先快后慢的过渡效果，这个效果跟系统相机的还是蛮接近的。  </p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CABasicAnimation</span> *animation = [<span class="built_in">CABasicAnimation</span> animation];</span><br><span class="line">animation.keyPath = <span class="string">@"borderWidth"</span>;</span><br><span class="line">animation.repeatCount = <span class="number">1</span>;</span><br><span class="line">animation.duration = <span class="number">0.4</span>;</span><br><span class="line">animation.removedOnCompletion = <span class="literal">NO</span>;</span><br><span class="line">animation.timingFunction = [<span class="built_in">CAMediaTimingFunction</span> functionWithControlPoints:<span class="number">0</span> :<span class="number">1</span> :<span class="number">1</span> :<span class="number">1</span>];</span><br><span class="line">animation.fillMode = kCAFillModeForwards;</span><br><span class="line">animation.fromValue = <span class="number">0.</span>f;</span><br><span class="line">animation.toValue = <span class="number">40.</span>f;</span><br><span class="line">[<span class="keyword">self</span>.previewMask addAnimation:animation forKey:<span class="string">@"changeBorderWith"</span>];</span><br></pre></td></tr></table></figure><p>效果如下：<br><img src="56030-61f16deba712d8ac.gif" alt=""></p><h3 id="用法5：用贝塞尔曲线做拟合计算"><a href="#用法5：用贝塞尔曲线做拟合计算" class="headerlink" title="用法5：用贝塞尔曲线做拟合计算"></a>用法5：用贝塞尔曲线做拟合计算</h3><p>贝塞尔曲线有个非常常用的动画效果，叫MetaBall算法。什么是MetaBall？就是我们平时看到的QQ的小红点消除啦~ 像下面这样。  </p><p><img src="56030-88174468ef9870e3.png" alt=""></p><p>这个是怎么实现的？</p><h4 id="矩形拟合"><a href="#矩形拟合" class="headerlink" title="矩形拟合"></a>矩形拟合</h4><p>首先我们需要了解一下简单的矩形拟合原理  </p><p><img src="56030-c2aa8094cd0a6004.png" alt=""></p><p>如图所示的两个圆，我们通过给它添加一个矩形（绿色部分），矩形较短的两边分别顶住两个圆各自的一条直径上，然后通过改变矩形较长的两边的弧度（红色部分），达到拟合的效果。  </p><p><img src="56030-9e2c8e268d676528.png" alt=""></p><p>这种做法当两个圆较小的时候，几乎是没有问题的。但是当圆稍微大点的时候，就会出现很明显的相交区域，拟合效果非常不好。  </p><p><img src="56030-4ad6b01ea2c03caa.png" alt=""></p><p>所以这种简单的矩形拟合在圆较大的时候是很不严格的。这个时候就需要更严谨的切线拟合。  </p><h4 id="切线拟合"><a href="#切线拟合" class="headerlink" title="切线拟合"></a>切线拟合</h4><p>我们知道，之前的矩形拟合之所以才圆大的时候会出现拟合不严谨的情况。为什么？</p><p><img src="56030-86bc9a9afdb15e48.png" alt=""></p><p>正如上图所示，两条曲线的画法都是由A1和B1为起点和终点，C点为控制点和A1、B2为起点和终点，C为控制点画出的二阶贝塞尔曲线。<br>而要做到完美的拟合，必须达到的一点要求就是，贝塞尔曲线与圆的连接点，也就是A1、B1、A2、B2，他们与控制点C的连线，一定要是圆的切线。这样就不管圆大小怎么变，都不会出现明显的相交区域了。</p><p><img src="56030-8c56a1e98f432000.jpg" alt="">  </p><blockquote><p>图片引用: <a href="http://www.jianshu.com/p/55c721887568" target="_blank" rel="noopener">http://www.jianshu.com/p/55c721887568</a></p></blockquote><p>于是，现在解决问题的关键就转变成了：如何计算这些拟合的关键点？</p><p><img src="56030-6700ecb2811dcac4.jpg" alt="">  </p><blockquote><p>图片引用: <a href="http://pandara.xyz/2015/10/27/ios_slime" target="_blank" rel="noopener">http://pandara.xyz/2015/10/27/ios_slime</a></p></blockquote><p>我们现在要做的，就是求出点ABCDMN这六个点的坐标，就可以实现完美拟合了。<br>结合上面两张图，通过三角函数的各种计算，我们最终可以得到如下代码：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)reloadBezierPath &#123;</span><br><span class="line">     <span class="built_in">CGFloat</span> r1 = <span class="keyword">self</span>.trailDot.frame.size.width / <span class="number">2.0</span>f;</span><br><span class="line">     <span class="built_in">CGFloat</span> r2 = <span class="keyword">self</span>.headDot.frame.size.width / <span class="number">2.0</span>f;</span><br><span class="line">     </span><br><span class="line">     <span class="built_in">CGFloat</span> x1 = <span class="keyword">self</span>.trailDot.center.x;</span><br><span class="line">     <span class="built_in">CGFloat</span> y1 = <span class="keyword">self</span>.trailDot.center.y;</span><br><span class="line">     <span class="built_in">CGFloat</span> x2 = <span class="keyword">self</span>.headDot.center.x;</span><br><span class="line">     <span class="built_in">CGFloat</span> y2 = <span class="keyword">self</span>.headDot.center.y;</span><br><span class="line">     </span><br><span class="line">     <span class="built_in">CGFloat</span> distance = sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1));</span><br><span class="line">     </span><br><span class="line">     <span class="built_in">CGFloat</span> sinDegree = (x2 - x1) / distance;</span><br><span class="line">     <span class="built_in">CGFloat</span> cosDegree = (y2 - y1) / distance;</span><br><span class="line">     </span><br><span class="line">     <span class="built_in">CGPoint</span> pointA = <span class="built_in">CGPointMake</span>(x1 - r1 * cosDegree, y1 + r1 * sinDegree);</span><br><span class="line">     <span class="built_in">CGPoint</span> pointB = <span class="built_in">CGPointMake</span>(x1 + r1 * cosDegree, y1 - r1 * sinDegree);</span><br><span class="line">     <span class="built_in">CGPoint</span> pointC = <span class="built_in">CGPointMake</span>(x2 + r2 * cosDegree, y2 - r2 * sinDegree);</span><br><span class="line">     <span class="built_in">CGPoint</span> pointD = <span class="built_in">CGPointMake</span>(x2 - r2 * cosDegree, y2 + r2 * sinDegree);</span><br><span class="line">     <span class="built_in">CGPoint</span> pointN = <span class="built_in">CGPointMake</span>(pointB.x + (distance / <span class="number">2</span>) * sinDegree, pointB.y + (distance / <span class="number">2</span>) * cosDegree);</span><br><span class="line">     <span class="built_in">CGPoint</span> pointM = <span class="built_in">CGPointMake</span>(pointA.x + (distance / <span class="number">2</span>) * sinDegree, pointA.y + (distance / <span class="number">2</span>) * cosDegree);</span><br><span class="line">     </span><br><span class="line">     <span class="built_in">UIBezierPath</span> *path = [<span class="built_in">UIBezierPath</span> bezierPath];</span><br><span class="line">     [path moveToPoint:pointA];</span><br><span class="line">     [path addLineToPoint:pointB];</span><br><span class="line">     [path addQuadCurveToPoint:pointC controlPoint:pointN];</span><br><span class="line">     [path addLineToPoint:pointD];</span><br><span class="line">     [path addQuadCurveToPoint:pointA controlPoint:pointM];</span><br><span class="line">     </span><br><span class="line">     <span class="keyword">self</span>.shapeLayer.path = path.CGPath;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>现在我们已经可以做到非常完美拟合的时候了，这时候再结合前面的通过修改控制点来实现图形曲线变换，我们就可以做到类似QQ小红点消除一样的效果了，具体做法不再赘述。</p><h2 id="Ending"><a href="#Ending" class="headerlink" title="Ending"></a>Ending</h2><p>至此，我们已基本了解了贝塞尔曲线的历史出处公式性质及各种用法。在不断学习的过程中，我发现一些比较牛逼的实现方法，都涉及到了较多较复杂的数学公式，奈何大学高数没有好好学，导致需要回头去看很多东西，这也是这篇博客耗费了较多时间的原因之一。不过在掌握了这些基础和基本用法之后，就可以再去研究一下比较高级和酷炫的用法了，也留下了很多坑，会在以后慢慢填补的…<br>如果以后还想补的话….<br>文中如果有什么不足之处欢迎指正，这也是Share的目的之一。<br>Have fun ~  </p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://zh.wikipedia.org/wiki/%E8%B2%9D%E8%8C%B2%E6%9B%B2%E7%B7%9A" target="_blank" rel="noopener">贝塞尔曲线维基百科</a><br><a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIBezierPath_class/" target="_blank" rel="noopener">UIBezierPath Class Reference</a><br><a href="http://www.html-js.com/article/1628" target="_blank" rel="noopener">贝塞尔曲线扫盲</a><br><a href="https://zsisme.gitbooks.io/ios-/content/chapter10/custom-easing-functions.html" target="_blank" rel="noopener">自定义缓冲函数</a><br><a href="http://www.jianshu.com/p/5dbdd1ee47aa" target="_blank" rel="noopener">iOS-UI进阶13 - 贝塞尔曲线和帧动画结合</a><br><a href="http://www.jianshu.com/p/55c721887568" target="_blank" rel="noopener">贝塞尔曲线开发的艺术</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近在做项目的时候，需要用到一个动画，非常简单的动画，简单到就是直接对一个View做平移… 然而虽然动画简单，但是却很不自然，尝试了UIView Animation提供的各类参数，都无法达到想要的动画效果。这时候，我的脑子里突然想起一个词… “贝塞尔曲线”…. 这个词经常看
      
    
    </summary>
    
    
      <category term="iOS" scheme="https://shixiong.name/tags/iOS/"/>
    
      <category term="贝塞尔" scheme="https://shixiong.name/tags/%E8%B4%9D%E5%A1%9E%E5%B0%94/"/>
    
      <category term="动画" scheme="https://shixiong.name/tags/%E5%8A%A8%E7%94%BB/"/>
    
  </entry>
  
  <entry>
    <title>断点调试 autolayout</title>
    <link href="https://shixiong.name/2016/09/16/breakpoint-debug-autolayout/"/>
    <id>https://shixiong.name/2016/09/16/breakpoint-debug-autolayout/</id>
    <published>2016-09-16T05:59:15.000Z</published>
    <updated>2019-07-30T02:17:17.769Z</updated>
    
    <content type="html"><![CDATA[<p><strong>对于 iOS 和 OS X 开发者来说，Autolayout已经逐渐变成一个至关重要的开发工具。它让多屏幕适配变得小菜一碟(peasy)，但是有些时候它还是会把我们搞疯掉，因为它总是会出现那些啰嗦又没啥用处的错误警告。</strong></p><p>就像这样:</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Unable to simultaneously satisfy constraints.</span><br><span class="line">Probably at least one of the constraints in the following list is one you don't want.</span><br><span class="line">Try <span class="keyword">this</span>:</span><br><span class="line"></span><br><span class="line">(1) look at each constraint and try to figure out which you don't expect;</span><br><span class="line">(<span class="number">2</span>) find the code that added the unwanted constraint or constraints and fix it.</span><br><span class="line">(Note: If you're seeing NSAutoresizingMaskLayoutConstraints that you don't understand, refer to the documentation for the UIView property translatesAutoresizingMaskIntoConstraints)</span><br><span class="line"></span><br><span class="line">(...........)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Make a symbolic breakpoint at <span class="built_in">UIViewAlertForUnsatisfiableConstraints</span> to catch <span class="keyword">this</span> <span class="keyword">in</span> the debugger.</span><br><span class="line">The methods <span class="keyword">in</span> the <span class="built_in">UIConstraintBasedLayoutDebugging</span> category on <span class="built_in">UIView</span> listed <span class="keyword">in</span> &lt;<span class="built_in">UIKit</span>/<span class="built_in">UIView</span>.h&gt; may also be helpful.</span><br></pre></td></tr></table></figure><p><strong>这么长的错误日志！！！！尼玛让谁看！！！</strong> </p><p>但是我们仔细看一下，观察 <code>NSLayoutConstraint</code> 部分。发现它倒数第二行还是有给我们点希望去解决这个错误的。在 <code>UIViewAlertForUnsatisfiableConstraints</code> 添加一个Symbolic breakpoint 断点。<br>既然这样，我们就去试一下…  </p><p><img src="http://upload-images.jianshu.io/upload_images/56030-030886b7b8cca75d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""> </p><p>尼玛！！ 毛用都没有啊！！它停在了线程堆栈上，然而LLDB依旧一片黑暗…  </p><p><strong>于是这里就有一个小技巧(Trick)，</strong>来让你的symbolic breakpoint变得更加有用。为你的ObjC项目添加 <code>po [[UIWindow keyWindow] _autolayoutTrace]</code></p><p>或者为你的Swift项目添加 <code>expr -l objc++ -O -- [[UIWindow keyWindow] _autolayoutTrace]</code>  </p><p><img src="http://upload-images.jianshu.io/upload_images/56030-b6505c77c0923c08.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><p>现在你就会在命令控制台看到你的UIView 的层次结构还有出现错误的地方。</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UIWindow</span>:<span class="number">0x7f9481c93360</span></span><br><span class="line">|   •<span class="built_in">UIView</span>:<span class="number">0x7f9481c9d680</span></span><br><span class="line">|   |   *<span class="built_in">UIView</span>:<span class="number">0x7f9481c9d990</span>- AMBIGUOUS LAYOUT <span class="keyword">for</span> <span class="built_in">UIView</span>:<span class="number">0x7f9481c9d990</span>.minX&#123;<span class="keyword">id</span>: <span class="number">13</span>&#125;, <span class="built_in">UIView</span>:<span class="number">0x7f9481c9d990</span>.minY&#123;<span class="keyword">id</span>: <span class="number">16</span>&#125;</span><br><span class="line">|   |   *_UILayoutGuide:<span class="number">0x7f9481c9e160</span>- AMBIGUOUS LAYOUT <span class="keyword">for</span> _UILayoutGuide:<span class="number">0x7f9481c9e160</span>.minY&#123;<span class="keyword">id</span>: <span class="number">17</span>&#125;</span><br><span class="line">|   |   *_UILayoutGuide:<span class="number">0x7f9481c9ebb0</span>- AMBIGUOUS LAYOUT <span class="keyword">for</span> _UILayoutGuide:<span class="number">0x7f9481c9ebb0</span>.minY&#123;<span class="keyword">id</span>: <span class="number">27</span>&#125;</span><br></pre></td></tr></table></figure><p>而当你在这个地方继续向下执行，它就会停在下一个你可能出现错误的地方。但是如果这样子你还是很难发现你的错误的话，你可以执行下面这个语句</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) e id $myView = (id) 0x7f9ea3d43410</span><br><span class="line">(lldb) e (void)[$myView setBackgroundColor:[UIColor blueColor]]</span><br></pre></td></tr></table></figure><p>先获取UIView，然后改变它的背景色</p><p>你就会看到出错误的视图主动显示出来了~</p><p><strong>ps: 如果是手写Autolayout，推荐 <a href="https://github.com/SnapKit/Masonry" target="_blank" rel="noopener">Mansory</a>，实在是好用！！</strong></p><p><strong>关键是它的错误提示</strong>  </p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Unable to simultaneously satisfy constraints......blah blah blah....</span><br><span class="line">(</span><br><span class="line">    <span class="string">"&lt;NSAutoresizingMaskLayoutConstraint:0x8887740 MASExampleDebuggingView:superview.height == 416&gt;"</span>,</span><br><span class="line">    <span class="string">"&lt;MASLayoutConstraint:ConstantConstraint UILabel:messageLabel.height &gt;= 5000&gt;"</span>,</span><br><span class="line">    <span class="string">"&lt;MASLayoutConstraint:BottomConstraint UILabel:messageLabel.bottom == MASExampleDebuggingView:superview.bottom - 10&gt;"</span>,</span><br><span class="line">    <span class="string">"&lt;MASLayoutConstraint:ConflictingConstraint[0] UILabel:messageLabel.top == MASExampleDebuggingView:superview.top + 1&gt;"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">Will attempt to recover by breaking constraint</span><br><span class="line">&lt;MASLayoutConstraint:ConstantConstraint <span class="built_in">UILabel</span>:messageLabel.height &gt;= <span class="number">5000</span>&gt;</span><br></pre></td></tr></table></figure><p>已经把出现错误的约束显示出来了，完全不需要我们去茫茫去偶遇~</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;对于 iOS 和 OS X 开发者来说，Autolayout已经逐渐变成一个至关重要的开发工具。它让多屏幕适配变得小菜一碟(peasy)，但是有些时候它还是会把我们搞疯掉，因为它总是会出现那些啰嗦又没啥用处的错误警告。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;就像这
      
    
    </summary>
    
    
      <category term="iOS" scheme="https://shixiong.name/tags/iOS/"/>
    
  </entry>
  
</feed>
